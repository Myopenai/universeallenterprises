# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  TAURI/ELECTRON CROSS-PLATFORM RELEASE                                   â•‘
# â•‘  [.TTT T,.&T,,.T,,,.T.] TOGETHERSYSTEMS                                   â•‘
# â•‘                                                                           â•‘
# â•‘  Baut reproduzierbare Installer fÃ¼r Windows, macOS, Linux                 â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ–¥ï¸ Desktop Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version fÃ¼r manuellen Build (z.B. 1.0.0)'
        required: false
        default: 'dev'

env:
  # Branding
  APP_NAME: TogetherSystems
  APP_IDENTIFIER: com.togethersystems.portal
  
  # Build
  NODE_VERSION: '20'
  RUST_VERSION: 'stable'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # METADATEN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  metadata:
    name: ðŸ“‹ Build Metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
      date: ${{ steps.version.outputs.date }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          elif [ "${{ github.event.inputs.version }}" != "dev" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="dev-$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  Build Metadata                                               â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Version: $VERSION"
          echo "â•‘  Commit:  ${GITHUB_SHA::7}"
          echo "â•‘  Date:    $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TAURI BUILD (CROSS-PLATFORM)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  build-tauri:
    name: ðŸ¦€ Tauri ${{ matrix.platform }}
    needs: metadata
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
            ext: .msi
            
          - platform: macos-intel
            os: macos-latest
            target: x86_64-apple-darwin
            ext: .dmg
            
          - platform: macos-arm
            os: macos-latest
            target: aarch64-apple-darwin
            ext: .dmg
            
          - platform: linux
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            ext: .AppImage

    steps:
      - uses: actions/checkout@v4
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SETUP
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}
          
      - name: Install Linux Dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf
            
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # BUILD
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: Install Dependencies
        run: npm ci
        
      - name: Inject Build Metadata
        run: |
          # Injiziere Version in HTML
          sed -i.bak "s/{{VERSION}}/${{ needs.metadata.outputs.version }}/g" src-tauri/index.html || true
          sed -i.bak "s/{{COMMIT}}/${{ needs.metadata.outputs.commit }}/g" src-tauri/index.html || true
          sed -i.bak "s/{{BUILD_DATE}}/${{ needs.metadata.outputs.date }}/g" src-tauri/index.html || true
          
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        with:
          tagName: v${{ needs.metadata.outputs.version }}
          releaseName: 'TogetherSystems v${{ needs.metadata.outputs.version }}'
          releaseBody: |
            ## ðŸš€ TogetherSystems v${{ needs.metadata.outputs.version }}
            
            **Build Info:**
            - Version: `${{ needs.metadata.outputs.version }}`
            - Commit: `${{ needs.metadata.outputs.commit }}`
            - Date: `${{ needs.metadata.outputs.date }}`
            
            **Downloads:**
            - ðŸªŸ Windows: `.msi` Installer
            - ðŸŽ macOS Intel: `.dmg` (x86_64)
            - ðŸŽ macOS ARM: `.dmg` (Apple Silicon)
            - ðŸ§ Linux: `.AppImage`
            
            ---
            [.TTT T,.&T,,.T,,,.T.] TOGETHERSYSTEMS. INTERNATIONAL TTT
          releaseDraft: true
          prerelease: ${{ contains(needs.metadata.outputs.version, 'dev') }}
          args: --target ${{ matrix.target }}
          
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ARTIFACTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: Generate Checksums
        run: |
          cd src-tauri/target/${{ matrix.target }}/release/bundle
          if [ -d "msi" ]; then sha256sum msi/*.msi > SHA256SUMS.txt; fi
          if [ -d "dmg" ]; then sha256sum dmg/*.dmg > SHA256SUMS.txt; fi
          if [ -d "appimage" ]; then sha256sum appimage/*.AppImage > SHA256SUMS.txt; fi
        shell: bash
        
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: togethersystems-${{ matrix.platform }}-${{ needs.metadata.outputs.version }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*${{ matrix.ext }}
            src-tauri/target/${{ matrix.target }}/release/bundle/**/SHA256SUMS.txt
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ELECTRON BUILD (FALLBACK)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  build-electron:
    name: âš¡ Electron ${{ matrix.platform }}
    needs: metadata
    if: github.event.inputs.electron == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            
          - platform: macos
            os: macos-latest
            
          - platform: linux
            os: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build Electron
        run: npm run electron:build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: togethersystems-electron-${{ matrix.platform }}-${{ needs.metadata.outputs.version }}
          path: dist_electron/*
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VERIFY & SIGN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  verify:
    name: âœ… Verify Artifacts
    needs: [metadata, build-tauri]
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: togethersystems-*
          path: artifacts
          
      - name: List & Verify
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  Build Artifacts                                              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          
          find artifacts -type f -name "*.msi" -o -name "*.dmg" -o -name "*.AppImage" | while read f; do
            SIZE=$(du -h "$f" | cut -f1)
            HASH=$(sha256sum "$f" | cut -c1-12)
            echo "â•‘  $(basename "$f") ($SIZE) [$HASH...]"
          done
          
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
      - name: Create Release Manifest
        run: |
          cat > artifacts/RELEASE-MANIFEST.json << EOF
          {
            "name": "TogetherSystems",
            "version": "${{ needs.metadata.outputs.version }}",
            "commit": "${{ needs.metadata.outputs.commit }}",
            "date": "${{ needs.metadata.outputs.date }}",
            "branding": "[.TTT T,.&T,,.T,,,.T.] TOGETHERSYSTEMS. INTERNATIONAL TTT",
            "platforms": ["windows", "macos-intel", "macos-arm", "linux"],
            "artifacts": $(find artifacts -type f \( -name "*.msi" -o -name "*.dmg" -o -name "*.AppImage" \) -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          }
          EOF
          
          cat artifacts/RELEASE-MANIFEST.json

