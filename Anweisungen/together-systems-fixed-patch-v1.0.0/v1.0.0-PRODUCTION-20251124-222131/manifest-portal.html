<!doctype html>
<html lang="de">
<head>
  <meta name="ts-branding" content="T,.&T,,.&T,,,.TOGETHERSYSTEMS. INTERNATIONAL TTT T,.&T,,.T,,,.(C) (+31) - ( 613 803 782.) https://orcid.org/0009-0003-1328-2430">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Manifest of Thinkers – Portal</title>
<style>
:root{
	--bg:#0f1419;
	--card:#111827;
	--ink:#e5e7eb;
	--muted:#9ca3af;
	--accent:#10b981;
	--accent-2:#f59e0b;
	--border:#1f2937;
	--radius:14px;
	/* Ambient-Overlay wird von ambient-media.js gesetzt (neon/grün, „Sunset-Strip“-Gefühl) */
	--ambient-overlay: radial-gradient(420px 260px at 5% 105%, rgba(34,197,94,0.25), transparent 70%);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
	margin:0;background:linear-gradient(180deg,#0b0f14,#0f1419 50%,#0b0f14);
	color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Oxygen,Cantarell,"Helvetica Neue",Arial,sans-serif;
}
.wr{max-width:1200px;margin:0 auto;padding:18px}
.hero{
	border-radius:22px;padding:20px;border:1px solid var(--border);
	background:
		radial-gradient(600px 200px at 10% 0%,#10b98122,transparent 60%),
		radial-gradient(600px 200px at 90% 0%,#f59e0b22,transparent 60%),
		var(--ambient-overlay),
		var(--card);
	position:relative;
	overflow:hidden;
}
/* Leichter Lichtblitz beim Theme-Wechsel */
.hero.ambient-pulse::after{
	content:'';
	position:absolute;
	inset:-20%;
	background:radial-gradient(circle at 10% -10%,rgba(190,242,100,0.35),transparent 60%);
	mix-blend-mode:screen;
	opacity:0;
	pointer-events:none;
	animation:ambientPulse 900ms ease-out forwards;
}
@keyframes ambientPulse{
	0%{opacity:0;}
	20%{opacity:0.8;}
	100%{opacity:0;}
}
.header{display:flex;align-items:center;gap:14px}
.badge{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:var(--accent);color:#00110b;font-weight:800}
h1{margin:0;font-size:22px}
.sub{color:var(--muted);font-size:13px}
.grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr;margin-top:18px}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.pad{padding:16px}
.title{font-size:14px;color:#d1d5db;margin:0 0 8px}
.btn{background:var(--accent);color:#00110b;border:none;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.alt{background:#1f2937;color:#e5e7eb;border:1px solid var(--border)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input[type="file"]{display:none}
input[type="url"], input[type="text"]{
	width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b0f14;color:var(--ink)
}
.pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#0b0f14;color:#d1d5db;font-size:12px}
.feed{padding:0}
.entry{padding:16px;border-top:1px solid var(--border)}
.entry:first-child{border-top:none}
.entry h3{margin:0 0 6px;font-size:18px}
.meta{color:var(--muted);font-size:12px}
.reactions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.reaction{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#0b0f14}
.comment{margin-top:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0b0f14}
.muted{color:var(--muted);font-size:12px}
.kbd{background:#0b0f14;border:1px solid var(--border);border-bottom-width:2px;padding:8px 10px;border-radius:10px;color:#d1d5db;white-space:pre-wrap;max-height:260px;overflow:auto}
.grid-2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
.warn{color:#fbbf24}
.ok{color:#34d399}
.live-chat{
	border-top:1px solid var(--border);
	margin-top:8px;
	padding-top:8px;
}
.live-chat-messages{
	max-height:220px;
	overflow-y:auto;
	margin-bottom:8px;
	font-size:13px;
}
.live-chat-message{
	margin-bottom:4px;
}
.live-chat-message .meta{
	font-size:11px;
	color:var(--muted);
}
.live-chat-input{
	display:flex;
	gap:6px;
	align-items:center;
}
.live-chat-input input{
	flex:1;
	min-width:0;
	padding:6px 8px;
	border-radius:10px;
	border:1px solid var(--border);
	background:#0b0f14;
	color:var(--ink);
}

/* Public copy-protection (soft) */
.public-view .content{user-select:none;-webkit-user-select:none}
.public-view *{ -webkit-touch-callout:none }
/* Harder attempts */
body.public-view{ --cursor: not-allowed }
.public-view .content::selection { background: transparent }

.dimmed-feed .entry{
	opacity:0.4;
	filter:grayscale(0.3);
}

/* TogetherSystems Branding-Leiste */
.ts-brand-banner{
  background:linear-gradient(90deg,#020617,#0f172a 50%,#111827);
  color:#e5e7eb;
  padding:4px 12px;
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
  border-bottom:1px solid rgba(148,163,184,.45);
}
.ts-brand-banner strong{font-weight:600;}
.ts-brand-sub{opacity:.78; display:block;}
.ts-brand-links a{
  color:#a5b4fc;
  text-decoration:none;
  font-size:11px;
  margin-left:8px;
  white-space:nowrap;
}

/* T,. Symbol vor jedem Menüpunkt */
.ts-brand-links a::before {
  content: "T,.";
  display: inline-block;
  margin-right: 4px;
  font-weight: 700;
  color: var(--accent, #10b981);
  font-size: 0.9em;
}

.ts-brand-links a:hover{text-decoration:underline;}

.voucher-layout{
	display:grid;
	grid-template-columns:1.4fr .9fr;
	gap:16px;
}
@media(max-width:960px){
	.voucher-layout{grid-template-columns:1fr;}
}
.voucher-list{
	display:flex;
	flex-direction:column;
	gap:10px;
}
.voucher-card{
	border:1px solid var(--border);
	border-radius:12px;
	padding:10px 12px;
	background:#0b0f14;
	cursor:pointer;
}
.voucher-card-header{
	display:flex;
	justify-content:space-between;
	align-items:center;
	margin-bottom:4px;
}
.voucher-badge{
	font-size:11px;
	padding:2px 6px;
	border-radius:999px;
	border:1px solid var(--border);
}
.voucher-badge.status-issued{border-color:#38bdf8;color:#bae6fd;}
.voucher-badge.status-booked{border-color:#22c55e;color:#bbf7d0;}
.voucher-badge.status-consumed{border-color:#a855f7;color:#e9d5ff;}
.voucher-badge.status-expired{border-color:#f97373;color:#fee2e2;}
.voucher-meta{
	font-size:11px;
	color:var(--muted);
}
.slot-calendar{
	margin-top:8px;
	border-top:1px dashed var(--border);
	padding-top:6px;
	font-size:11px;
	color:var(--muted);
	display:flex;
	flex-direction:column;
	gap:4px;
}
.slot-calendar-day{
	display:flex;
	justify-content:space-between;
	align-items:center;
}
.slot-calendar-badges{
	display:flex;
	gap:4px;
	flex-wrap:wrap;
}
.slot-list{
	display:flex;
	flex-direction:column;
	gap:6px;
	font-size:12px;
}
.slot-item{
	display:flex;
	justify-content:space-between;
	align-items:center;
	border:1px solid var(--border);
	border-radius:10px;
	padding:6px 8px;
	background:#020617;
}

</style>
  <link rel="stylesheet" href="./css/da-vinci-xxxxxl-enterprise-standard.css">
</head>
<body class="public-view">
  <div class="ts-brand-banner">
    <div>
      <strong>T,.&T,,.&T,,,.TOGETHERSYSTEMS. INTERNATIONAL TTT T,.&T,,.T,,,.(C)</strong>
      <span class="ts-brand-sub">(+31) - ( 613 803 782.) <a href="https://orcid.org/0009-0003-1328-2430" target="_blank" rel="noopener noreferrer" style="color:#a5b4fc;text-decoration:underline;">https://orcid.org/0009-0003-1328-2430</a></span>
    </div>
    <div class="ts-brand-links">
      <a href="./index.html">← Zurück</a>
      <a href="./index.html">Portal</a>
      <a href="./help-portal.html">Portal-Hilfe</a>
      <a href="./manifest-forum.html">Manifest</a>
      <a href="./help-manifest.html">Manifest-Hilfe</a>
      <a href="./manifest-portal.html">Online-Portal</a>
      <a href="./help-online-portal.html">Online-Portal-Hilfe</a>
					<a href="./honeycomb.html">Räume & Gruppen</a>
      <a href="./help-honeycomb.html">Wabenräume-Hilfe</a>
					<a href="./legal-hub.html">Verträge & Recht</a>
      <a href="./help-legal-hub.html">Legal-Hub-Hilfe</a>
					<a href="TELBANK/index.html" title="Zahlungen & Guthaben">💰 Zahlungen & Guthaben</a>
      <a href="business-admin.html" title="Business-Admin – Vouchers & Buchungen">📊 Business-Admin</a>
      <a href="admin-monitoring.html" title="Monitoring & Events">📈 Monitoring</a>
      <a href="TsysytemsT/TsysytemsT.html" title="One Network · One Humanity · OPS / OSP">🌐 One&nbsp;Network</a>
      <a href="https://www.gofundme.com/f/magnitudo?utm_campaign=unknown&amp;utm_medium=referral&amp;utm_source=widget" target="_blank" rel="noopener" title="Teilnahme an der Einsammlung (5–33.000&nbsp;€)">💠 Unterstützen</a>
      <a href="https://www.tinyurl.com/bugcompany" target="_blank" rel="noopener" title="Großunternehmen &amp; Stiftungen">🏛️ Big&nbsp;Support</a>
    </div>
  </div>
  <!-- Portal verbessern Feedback-Button (immer sichtbar) -->
  <button id="feedbackBtn" style="position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:var(--accent);color:#00110b;border:none;font-size:20px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:9999;" title="Portal verbessern">✉</button>

	<div class="wr">
		<!-- Neue vereinfachte Navigation -->
		<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;">
			<div style="display:flex;align-items:center;gap:8px;">
				<strong style="font-size:16px;">TogetherSystems</strong>
				<span style="color:var(--muted);font-size:12px;">– deine Kommunikations-Schaltzentrale für Business & Alltag</span>
			</div>
			<div style="display:flex;gap:8px;flex-wrap:wrap;">
				<button class="btn" id="navHome" style="font-size:12px;padding:6px 12px;">🏠 Home</button>
				<button class="btn alt" id="navContacts" style="font-size:12px;padding:6px 12px;">👥 Kontakte</button>
				<button class="btn alt" id="navRooms" style="font-size:12px;padding:6px 12px;">🏛️ Räume</button>
				<button class="btn alt" id="navDocuments" style="font-size:12px;padding:6px 12px;">📄 Dokumente</button>
				<button class="btn alt" id="navFinance" style="font-size:12px;padding:6px 12px;">💰 Finanzen</button>
				<button class="btn alt" id="navExpert" style="font-size:12px;padding:6px 12px;" title="Expertenmodus">⚙️</button>
			</div>
		</div>

		<!-- Kommunikations-Cockpit: "Was möchtest du tun?" -->
		<div class="hero" data-ambient-slot="hero-portal" id="communicationCockpit" style="margin-bottom:18px;">
			<div style="text-align:center;padding:20px;">
				<h2 style="margin:0 0 12px;font-size:20px;">Was möchtest du tun?</h2>
				<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;margin-top:16px;">
					<button class="btn" id="actionMessage" style="padding:16px;font-size:14px;display:flex;flex-direction:column;align-items:center;gap:8px;">
						<span style="font-size:24px;">💬</span>
						<span>Nachricht senden</span>
					</button>
					<button class="btn" id="actionCall" style="padding:16px;font-size:14px;display:flex;flex-direction:column;align-items:center;gap:8px;">
						<span style="font-size:24px;">📞</span>
						<span>Call starten</span>
					</button>
					<button class="btn" id="actionFile" style="padding:16px;font-size:14px;display:flex;flex-direction:column;align-items:center;gap:8px;">
						<span style="font-size:24px;">📎</span>
						<span>Datei senden</span>
					</button>
					<button class="btn" id="actionAppointment" style="padding:16px;font-size:14px;display:flex;flex-direction:column;align-items:center;gap:8px;">
						<span style="font-size:24px;">📅</span>
						<span>Termin anbieten</span>
					</button>
					<button class="btn" id="actionContract" style="padding:16px;font-size:14px;display:flex;flex-direction:column;align-items:center;gap:8px;">
						<span style="font-size:24px;">📝</span>
						<span>Vertrag senden</span>
					</button>
					<button class="btn alt" id="actionMore" style="padding:16px;font-size:14px;display:flex;flex-direction:column;align-items:center;gap:8px;">
						<span style="font-size:24px;">➕</span>
						<span>Mehr...</span>
					</button>
				</div>
			</div>
		</div>

		<!-- Lebenslagen-Vorlagen (versteckt, wird bei "Mehr..." angezeigt) -->
		<div class="panel" id="lifeTemplates" style="display:none;margin-bottom:18px;">
			<div class="pad">
				<h3 class="title">Lebenslagen-Vorlagen</h3>
				<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));gap:10px;margin-top:12px;">
					<button class="btn alt" data-template="sell" style="padding:12px;text-align:left;">
						<strong>💰 Verkaufen / Angebot</strong><br>
						<small style="opacity:0.7;">Artikel oder Dienstleistung anbieten</small>
					</button>
					<button class="btn alt" data-template="birth" style="padding:12px;text-align:left;">
						<strong>👶 Neue Geburt feiern</strong><br>
						<small style="opacity:0.7;">Geburtsanzeige & Glückwünsche</small>
					</button>
					<button class="btn alt" data-template="condolence" style="padding:12px;text-align:left;">
						<strong>🕯️ Trauer & Kondolenz</strong><br>
						<small style="opacity:0.7;">Beileidsbekundung senden</small>
					</button>
					<button class="btn alt" data-template="consulting" style="padding:12px;text-align:left;">
						<strong>💼 Beratung/Coaching buchen</strong><br>
						<small style="opacity:0.7;">Termin für Beratung anfragen</small>
					</button>
					<button class="btn alt" data-template="realestate" style="padding:12px;text-align:left;">
						<strong>🏠 Immobilie/Haus anfragen</strong><br>
						<small style="opacity:0.7;">Hypotheken-Anfrage stellen</small>
					</button>
					<button class="btn alt" data-template="machine" style="padding:12px;text-align:left;">
						<strong>⚙️ Maschinenzeit buchen</strong><br>
						<small style="opacity:0.7;">Studio oder Gerät reservieren</small>
					</button>
					<button class="btn alt" data-template="membership" style="padding:12px;text-align:left;">
						<strong>👥 Mitgliedschaft starten</strong><br>
						<small style="opacity:0.7;">Community oder Verein beitreten</small>
					</button>
				</div>
			</div>
		</div>

		<div class="grid" style="margin-top:18px">
			<main class="panel feed" id="feed"></main>
			<aside class="panel">
				<!-- Verifizierung bleibt sichtbar (wichtig für User) -->
				<div class="pad">
					<h3 class="title">Verifizierung</h3>
					<div class="grid-2">
						<input id="token" type="text" placeholder="Token aus Offline-Forum (automatisch via Link)">
						<button class="btn" id="verifyBtn">Verifizieren</button>
					</div>
					<p class="muted">Wenn du das Offline-Forum nutzt und über „Portal öffnen" kommst, wird der Token automatisch im Link übergeben. Manuell kannst du ihn hier einfügen.</p>
				</div>
				<!-- Tech-Blöcke: Nur im Expertenmodus sichtbar -->
				<div id="expertMode" style="display:none;">
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Token-URL generieren (Expertenmodus)</h3>
					<p class="muted">Gib ein Basis‑Token ein, klicke auf „URL generieren“ und kopiere die fertige Portal‑Adresse inklusive <code>#mot</code>, <code>ts</code> und <code>sig</code>.</p>
					<div class="grid-2">
						<input id="genBaseToken" type="text" placeholder="Dein Basis‑Token (z. B. mot-shared-token-v1)">
						<button class="btn alt" id="generateUrlBtn" type="button">URL generieren</button>
					</div>
					<p class="muted" style="margin-top:6px">Fertige URL (kann 1:1 weitergegeben werden):</p>
					<textarea id="generatedUrl" class="kbd" readonly rows="3" style="width:100%;min-height:72px;"></textarea>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Daten laden</h3>
					<div class="row">
						<label for="jsonFile" class="btn alt" style="cursor:pointer">JSON importieren</label>
						<input id="jsonFile" type="file" accept="application/json">
						<button class="btn alt" id="payloadBtn">Payload anzeigen</button>
					</div>
					<p class="muted">Für Live-Betrieb kann hier eine API-Quelle konfiguriert werden.</p>
					<div style="margin-top:10px">
						<select id="apiPreset" class="muted" style="width:100%;margin-bottom:6px;background:#0b0f14;border:1px solid var(--border);border-radius:10px;padding:6px 8px;">
							<option value="">API-Vorlage wählen (optional)</option>
							<option value="supabase">Supabase REST (Beispiel)</option>
							<option value="firebase">Firebase Callable (Beispiel)</option>
							<option value="custom">Eigene URL (manuell)</option>
						</select>
						<input id="apiUrl" type="url" placeholder="https://deine-seite.tld/api/manifest/list">
						<div class="row" style="margin-top:8px">
							<button class="btn" id="fetchBtn">Von API laden</button>
							<button class="btn alt" id="clearBtn">Feed leeren</button>
						</div>
					</div>
					<pre class="kbd" id="payloadBox" hidden></pre>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Admin-Moderation</h3>
					<p class="muted">Werkzeuge, um den öffentlichen Feed lokal zu steuern (nur in diesem Browser wirksam).</p>
					<div class="row">
						<button class="btn alt" id="verbergenBtn" type="button">Beiträge verbergen</button>
						<button class="btn alt" id="sichtbarBtn" type="button">Beiträge sichtbar machen</button>
						<button class="btn alt" id="statsBtn" type="button">Statistik anzeigen</button>
					</div>
					<div class="row" style="margin-top:6px;">
						<select id="moderationScope" class="muted" style="width:100%;background:#0b0f14;border:1px solid var(--border);border-radius:10px;padding:6px 8px;">
							<option value="local">Nur dieser Browser</option>
							<option value="session">Aktuelle Sitzung</option>
						</select>
					</div>
					<p class="muted" id="moderationStatus" style="font-size:11px;margin-top:4px;">Noch keine Moderations-Aktion ausgeführt.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Live-Funktionen (Zero-Input-Flow)</h3>
					<p class="muted" style="margin-bottom:8px;">Ein-Klick-Kommunikation – keine Konfiguration nötig.</p>
					<div class="row" style="gap:6px;margin-bottom:8px;">
						<button class="btn" id="quickCallBtn" type="button" style="flex:1;">📞 Call starten</button>
						<button class="btn" id="quickChatBtn" type="button" style="flex:1;">💬 Chat starten</button>
						<button class="btn" id="quickGroupBtn" type="button" style="flex:1;">👥 Gruppe starten</button>
					</div>
					<div class="row" style="margin-top:8px;">
						<select id="signalPreset" class="muted" style="width:100%;margin-bottom:6px;background:#0b0f14;border:1px solid var(--border);border-radius:10px;padding:6px 8px;">
							<option value="">Signaling-Vorlage wählen (optional)</option>
							<option value="cloudflare">Cloudflare Pages WebSocket (automatisch)</option>
							<option value="local">Lokaler Server (localhost:3100)</option>
							<option value="twilio">Twilio Video (Beispiel)</option>
							<option value="ably">Ably Realtime (Beispiel)</option>
							<option value="custom">Eigene WSS-URL (manuell)</option>
						</select>
					</div>
					<div class="row">
						<input id="signalUrl" type="url" placeholder="wss://signaling.deine-seite.tld (optional)">
						<button class="btn alt" id="initLiveBtn">Live initialisieren</button>
					</div>
					<p class="muted" style="font-size:11px;margin-top:4px;">Signaling wird automatisch erkannt. Buttons oben starten sofort ohne Konfiguration.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Hidden Viewer, Medien &amp; Datei-Transfer</h3>
					<p class="muted">
						Dieser Bereich bündelt die UI für einen versteckten Viewer, einfache Medien-Steuerung
						und einen R2‑Datei‑Transfer (Demo‑Status, ohne Pflicht‑Backend).
					</p>
					<div class="row" style="margin-top:4px;">
						<button class="btn alt" id="loadHiddenBtn" type="button">Hidden Viewer laden</button>
					</div>
					<div class="row" style="margin-top:8px;">
						<input id="filePick" type="file" multiple>
						<span class="muted" id="filePickStatus" style="font-size:11px;">Noch keine Dateien ausgewählt.</span>
					</div>
					<div class="row" style="margin-top:4px;">
						<input id="p2pFileInput" type="file" multiple>
						<span class="muted" style="font-size:11px;">P2P‑Datei‑Transfer (Demo‑Eingang, optionales Mesh/R2‑Backend).</span>
					</div>
					<div class="row" style="margin-top:8px;">
						<button class="btn alt" id="startMediaBtn" type="button">Media starten</button>
						<button class="btn alt" id="stopMediaBtn" type="button">Media stoppen</button>
					</div>
					<p class="muted" id="mediaStatus" style="font-size:11px;margin-top:4px;">Media-/Streams sind noch inaktiv.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Live-Raum erstellen (No-Code)</h3>
					<p class="muted">Definiere einen Raum komplett über Formular. Das Portal erzeugt das passende JSON für dein Backend.</p>
					<div class="row">
						<select id="roomType" style="flex:1;min-width:120px;background:#0b0f14;border:1px solid var(--border);border-radius:10px;padding:6px 8px;color:var(--fg);">
							<option value="text">Text‑Raum</option>
							<option value="video">Video‑Raum</option>
							<option value="file">Datei‑Austausch</option>
							<option value="contract">Vertrags‑Raum</option>
						</select>
						<input id="roomId" type="text" placeholder="Raum-ID (z. B. post-123 oder wabe A-2)" style="flex:1;min-width:160px;">
					</div>
					<p class="muted" style="margin-top:6px">Rechte in diesem Raum:</p>
					<div class="row" style="font-size:12px;color:var(--muted);margin-top:2px">
						<label><input type="checkbox" id="permRead" checked> lesen</label>
						<label><input type="checkbox" id="permSend" checked> senden</label>
						<label><input type="checkbox" id="permSign"> unterschreiben</label>
						<label><input type="checkbox" id="permUpload"> hochladen</label>
					</div>
					<div class="row" style="margin-top:8px">
						<button class="btn alt" id="buildRoomJsonBtn" type="button" aria-label="Raum-JSON anzeigen">Raum-JSON anzeigen</button>
					</div>
					<pre class="kbd" id="roomJsonBox" style="margin-top:6px;min-height:80px;"></pre>
					<p class="muted">Dieses JSON kannst du 1:1 an dein Backend (API oder Signaling‑Server) weitergeben.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Direktverbinden (Auto‑Connect)</h3>
					<p class="muted">Optionales Stichwort, um dich mit anderen Thinkern zu koppeln (z. B. „projekt_alpha“, „familie“, „beratung“). Das Matching läuft automatisch im Hintergrund.</p>
					<label class="muted" style="font-size:12px;display:block;margin-bottom:4px;">
						Raum-Stichwort:
						<input id="pairCodeInput" type="text" placeholder="z.B. projekt_alpha, familie, beratung">
					</label>
					<div class="muted" id="connectStatus" style="font-size:12px;margin-top:4px;">
						Warte auf Verbindungsaufbau …
					</div>
				</div>
			</aside>
		</div>
		<section class="panel" id="business-sectors" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">Geschäftsbereiche &amp; Verträge (Überblick)</h3>
				<p class="muted">
					Das Portal ist nicht nur ein Nachrichten‑Feed, sondern eine Schaltzentrale für verschiedene Geschäftsbereiche,
					in denen echte Kontrakte und Transaktionen ablaufen können. Die wichtigsten Bausteine:
				</p>
				<div class="row" style="margin-top:8px;flex-wrap:wrap;gap:10px;">
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">🏠 Häusermarkt &amp; Hypotheken</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Immobilien‑Anfragen, Angebote und Verträge für Häuser/Wohnungen. Beispiel‑Flow im
							Bereich „Immobilien &amp; Hypotheken (Demo)“.
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							<a href="#mortgage-panel">Zum Häusermarkt‑Demo springen</a>
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">💼 Unternehmensfinanzierung &amp; Kredite</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Firmen‑Kredite, Zwischenfinanzierungen und Projekt‑Deals können über denselben Mechanismus wie Hypotheken
							abgebildet werden (Anfrage → Angebot → Vertrag).
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							Technischer Anker: Hypotheken‑API + Voucher‑System.
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">🎫 Events, Sessions &amp; Termine</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Beratung, Therapie, Coaching, Unterricht, Konferenzen – alles, was über Slots und Rechte gesteuert wird.
							Voucher dienen als Eintrittskarte in einen Waben‑ oder Live‑Raum.
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							<a href="#voucher-panel">Zu „Voucher &amp; Termine“ springen</a>
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">⚙️ Maschinenzeit &amp; Geräte</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Stundenweise Nutzung von Maschinen, Studios, Fahrzeugen oder Geräten. Die Plattform kann Slots, Zugänge
							und Vertrags‑PDFs bündeln.
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							Technischer Anker: Voucher‑Slots + Legal‑Hub‑Verträge.
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">👥 Mitgliedschaften &amp; Abos</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Vereine, Communities, Plattform‑Zugänge – Mitgliedschafts‑Voucher verknüpfen Rechte mit Personen
							und Räumen (z.&nbsp;B. geschlossene Waben).
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							Technischer Anker: wiederverwendbare Voucher‑Templates.
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">💶 Zahlungsflüsse &amp; Telbank</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Krypto‑Ein/Ausgänge, Bank‑/Skrill‑Referenzen und Abrechnung. TPGA‑Telbank dokumentiert,
							wie Geld als Kommunikations‑System zwischen Wallet und klassischer Finanzwelt fließt.
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							Eigene App: <code>TELBANK/index.html</code> (MetaMask &amp; Transfer‑Log).
						</p>
					</div>
				</div>
			</div>
		</section>
		<section class="panel" id="voucher-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title" role="heading">Termine &amp; Buchungen</h3>
				<p class="muted">
					Hier verwaltest du zeitbasierte Leistungen (Vouchers) und buchbare Termine. Wähle oben deine Rolle und klicke auf einen Voucher,
					um freie Slots zu sehen und Buchungen vorzunehmen. Über die Branchen‑Vorlagen kannst du typische Angebote mit einem Klick erstellen.
				</p>
				<div class="row" style="margin-top:8px;">
					<button class="btn alt" id="voucherModeCustomer" type="button">Ich bin Kunde</button>
					<button class="btn alt" id="voucherModeIssuer" type="button">Ich bin Anbieter</button>
					<button class="btn" id="btnVoucherRefresh" type="button">Aktualisieren</button>
				</div>
				<div class="row" style="margin-top:6px;font-size:11px;">
					<span class="muted" style="flex:1;min-width:120px;">Branchen‑Vorlagen:</span>
					<button class="btn alt" type="button" data-voucher-template="consulting" style="font-size:11px;">💬 Beratung 60&nbsp;Min</button>
					<button class="btn alt" type="button" data-voucher-template="therapy" style="font-size:11px;">🧠 Therapie‑Session</button>
					<button class="btn alt" type="button" data-voucher-template="viewing" style="font-size:11px;">🏠 Haus‑Besichtigung</button>
					<button class="btn alt" type="button" data-voucher-template="machine" style="font-size:11px;">⚙️ Maschinenzeit</button>
					<button class="btn alt" type="button" data-voucher-template="membership" style="font-size:11px;">👥 Membership</button>
				</div>
				<div class="voucher-layout" style="margin-top:10px;">
					<div>
						<h4 class="title" style="margin-bottom:4px;">Vouchers</h4>
						<div class="voucher-list" id="voucherList"></div>
					</div>
					<div>
						<h4 class="title" style="margin-bottom:4px;">Verfügbare Slots</h4>
						<div class="slot-list" id="slotList"></div>
						<div class="slot-calendar" id="slotCalendar"></div>
						<p class="muted" style="font-size:10px;margin-top:4px;">
							Der Kalender fasst freie Slots pro Tag zusammen (basierend auf den vom Backend gelieferten Stunden‑Slots).
						</p>
					</div>
				</div>
				<p class="muted" style="font-size:11px;margin-top:6px;">
					Die Daten kommen aus der Cloudflare Pages Functions API (/api/voucher/*). Für lokale Entwicklung sollte hier ein lokaler Server gestartet werden.
				</p>
			</div>
		</section>
		<section class="panel" id="events-memberships-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title" role="heading">Events &amp; Memberships – Übersicht</h3>
				<p class="muted">
					Diese Übersicht fasst alle Vouchers für Beratungs‑/Therapie‑Sessions und Membership‑Zugänge zusammen,
					die du ausgestellt hast. So siehst du auf einen Blick, wie viele Events und Mitgliedschaften aktiv sind.
				</p>
				<pre class="kbd" id="eventsMembershipsOutput" style="margin-top:6px;max-height:220px;"></pre>
				<p class="muted" style="font-size:11px;margin-top:4px;">
					Technischer Hinweis: Die Daten werden aus derselben Voucher‑API gelesen wie „Voucher &amp; Termine“
					und nach <code>serviceType</code> gefiltert (<code>consulting.session</code>, <code>therapy.session</code>, <code>membership.access</code>).
				</p>
			</div>
		</section>
		<section class="panel" id="my-bookings-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title" role="heading">Meine Buchungen (Autopilot-Übersicht)</h3>
				<p class="muted">
					Hier siehst du alle Termine, die mit deiner Browser‑ID gebucht wurden.
					Die Daten kommen direkt aus der Datenbank (<code>voucher_bookings</code>).
				</p>
				<div class="slot-list" id="myBookingsList" style="margin-top:8px;"></div>
			</div>
		</section>
		<section class="panel" id="verticals-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title" role="heading">Vertikale Konsolen – Maschinen, Events, Memberships</h3>
				<p class="muted">
					Diese drei Übersichten zeigen dieselben Voucher‑Daten aus unterschiedlichen Blickwinkeln:
					<strong>Maschinenzeit</strong>, <strong>Events &amp; Sessions</strong> und <strong>Memberships</strong>.
					Die Daten stammen direkt aus der D1‑basierten Voucher‑API.
				</p>
				<div class="voucher-layout" style="margin-top:10px;">
					<div>
						<h4 class="title" style="margin-bottom:4px;">⚙️ Maschinenzeit</h4>
						<table style="width:100%;border-collapse:collapse;font-size:11px;">
							<thead>
								<tr>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Maschine</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Standort</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Preis</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Status</th>
								</tr>
							</thead>
							<tbody id="machinesTableBody">
								<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Noch keine Maschinen‑Vouchers gefunden.</td></tr>
							</tbody>
						</table>
					</div>
					<div>
						<h4 class="title" style="margin-bottom:4px;">🎫 Events &amp; 👥 Memberships</h4>
						<table style="width:100%;border-collapse:collapse;font-size:11px;">
							<thead>
								<tr>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Typ</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Titel</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Status</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Zeitraum</th>
								</tr>
							</thead>
							<tbody id="eventsMembershipsTableBody">
								<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Noch keine Events/Memberships gefunden.</td></tr>
							</tbody>
						</table>
					</div>
				</div>
				<p class="muted" style="font-size:11px;margin-top:6px;">
					Technischer Hinweis: Maschinenzeit nutzt <code>serviceType='machine.timeslot'</code>,
					Events <code>consulting.session</code>/<code>therapy.session</code>/<code>realestate.viewing</code>,
					Memberships <code>membership.access</code>. Alle Daten kommen aus <code>/api/voucher/list</code>.
				</p>
			</div>
		</section>
		<section class="panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">Gesellschaftlicher Pfeiler · Freiwillige Beteiligung</h3>
				<p class="muted">
					TogetherSystems ist wie eine Armbanduhr mit Gürtelschnalle: Offline‑Manifest und Online‑Portal schnappen zusammen,
					sobald du „online“ gehst – und lösen sich wieder, wenn du das Gerät trennst. Dieses dauerhafte Zusammenspiel verdient
					eine freiwillige Beteiligung derjenigen, die es regelmäßig nutzen.
				</p>
				<p class="muted">
					Mit jedem Beitrag zwischen <strong>5&nbsp;€</strong> und <strong>33.000&nbsp;€</strong> hilfst du, diesen Pfeiler zu stabilisieren
					und weitere Projekte des Producers (über 500 geplante Pfeiler) zu ermöglichen. Nach Erreichen der 33.000&nbsp;€ kann die Plattform
					in Absprache mit Förderern weiter ausgebaut werden.
				</p>
				<div class="row" style="margin-top:6px;">
					<a class="btn" href="https://www.gofundme.com/f/magnitudo?utm_campaign=unknown&amp;utm_medium=referral&amp;utm_source=widget" target="_blank" rel="noopener">
						💠 Beitrag 5–33.000&nbsp;€
					</a>
					<a class="btn alt" href="https://www.tinyurl.com/bugcompany" target="_blank" rel="noopener">
						🏛️ Großunternehmen / Stiftungen
					</a>
				</div>
				<p class="muted" style="margin-top:6px;font-size:11px;">
					Die Nutzung des Portals bleibt frei, ohne Accounts und ohne Paywall. Die Einsammlung ist ein Zusatz‑Kanal für alle,
					die das System als dauerhaften gesellschaftlichen Baustein sehen.
				</p>
			</div>
		</section>
		<section class="panel" id="yfood-sponsor" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">🍽️ YFood – Complete Food &amp; Trink-Food</h3>
				<p class="muted">
					YFood bietet vollständige Mahlzeiten und Getränke für unterwegs. Perfekt für alle, die sich ausgewogen ernähren möchten, ohne Zeit zu verlieren.
				</p>
				<div style="margin-top:12px;position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;border:1px solid var(--border);">
					<iframe 
						style="position:absolute;top:0;left:0;width:100%;height:100%;" 
						src="https://www.youtube.com/embed/ZYOQiBDsZo0" 
						title="YFood Werbung" 
						frameborder="0" 
						allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
						allowfullscreen>
					</iframe>
				</div>
				<p class="muted" style="margin-top:8px;font-size:11px;">
					<a href="https://www.yfood.eu" target="_blank" rel="noopener" style="color:var(--accent);">YFood auf yfood.eu entdecken</a> · 
					Vollständige Mahlzeiten &amp; Trink-Food für deinen Alltag
				</p>
			</div>
		</section>
		<section class="panel" id="mortgage-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">Immobilien &amp; Hypotheken (Demo)</h3>
				<p class="muted">
					Dieser Bereich zeigt beispielhaft, wie der Hypotheken-Flow aus dem Meta-Transaktionsportal implementiert wird.
					Die Daten kommen aus der lokalen Mortgage-API (In-Memory).
				</p>
				<div class="row" style="margin-top:8px;">
					<button class="btn alt" id="btnLoadApplications" type="button">Meine Anfragen laden</button>
					<button class="btn alt" id="btnLoadOffers" type="button">Meine Angebote laden</button>
					<button class="btn alt" id="btnNewApplication" type="button">Beispiel-Anfrage erzeugen</button>
				</div>
				<pre class="kbd" id="mortgageOutput" style="margin-top:8px;max-height:260px;"></pre>
			</div>
		</section>
		<section class="panel" id="liveRoom" style="margin-top:18px;display:none;">
			<div class="pad">
				<h3 class="title">Live-Raum</h3>
				<p class="muted" id="liveRoomInfo">Noch kein Live-Raum aktiv. Sobald ein Match gefunden wird, erscheint hier die Verbindungsinformation.</p>
				<div class="live-chat" id="liveChat" style="display:none;">
					<h4 class="title" style="font-size:13px;margin-top:4px;">Live-Textkanal</h4>
					<div class="live-chat-messages" id="liveChatMessages"></div>
					<div class="live-chat-input">
						<input id="liveChatInput" type="text" placeholder="Nachricht eingeben und Enter drücken …">
						<button class="btn alt" id="liveChatSendBtn" type="button">Senden</button>
					</div>
					<p class="muted" style="font-size:11px;margin-top:4px;">
						Der Textkanal läuft über den Signaling-Server (WebSocket). Video- und Datei-Kanäle können später auf derselben room_id aufsetzen.
					</p>
				</div>
			</div>
		</section>
		<section class="panel" id="suppliers-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">Lieferanten &amp; Provider – Milchkannen-Übersicht</h3>
				<p class="muted">
					Dieser Bereich zeigt eine vereinfachte Übersicht der aktuell konfigurierten Provider-Profile
					(„Milchkannen“), die sich automatisch an das Portal anhängen können. Die technische Quelle ist
					<code>config/providers.json</code>. Er ist in erster Linie zur Orientierung und Dokumentation gedacht.
				</p>
				<div id="suppliersList" class="slot-list" style="margin-top:8px;"></div>
				<p class="muted" style="font-size:11px;margin-top:6px;">
					Technischer Hinweis: Die Daten werden über <code>router.js</code> geladen. Neue Lieferanten können
					später über dasselbe Schema eingehängt werden (Bauern, Provider, Autohändler, weitere Branchen).
				</p>
			</div>
		</section>
	</div>

<script>
// Eingebetteter Minimal-Core, damit das Portal auch als heruntergeladene Datei (file://) funktioniert.
const MOT_STORAGE_KEYS = {
	USER_ID: 'mot_user_id_v1',
	VERIFIED: 'mot_verified_v1'
};
function generateRandomId(length = 22){
	const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	let result = '';
	const array = new Uint32Array(length);
	if (window.crypto && window.crypto.getRandomValues) {
		window.crypto.getRandomValues(array);
		for (let i = 0; i < length; i++) {
			result += chars[array[i] % chars.length];
		}
	} else {
		for (let i = 0; i < length; i++) {
			result += chars[Math.floor(Math.random() * chars.length)];
		}
	}
	return result;
}
function getOrCreateUserId(){
	try{
		let uid = localStorage.getItem(MOT_STORAGE_KEYS.USER_ID);
		if(!uid){
			uid = generateRandomId();
			localStorage.setItem(MOT_STORAGE_KEYS.USER_ID, uid);
		}
		return uid;
	}catch{
		return generateRandomId();
	}
}
function parseHashParams(){
	const hash = window.location.hash && window.location.hash.startsWith('#')
		? window.location.hash.slice(1)
		: window.location.hash || '';
	const params = new URLSearchParams(hash);
	const obj = {};
	for (const [k, v] of params.entries()) obj[k] = v;
	return obj;
}
function markUserVerified({ uid, mot, ts, sig } = {}){
	if(!uid) uid = getOrCreateUserId();
	try{
		localStorage.setItem(MOT_STORAGE_KEYS.USER_ID, uid);
		localStorage.setItem(
			MOT_STORAGE_KEYS.VERIFIED,
			JSON.stringify({ uid, mot: mot || null, ts: ts || null, sig: sig || null })
		);
	}catch{/* ignore */}
}
function isUserVerified(){
	try{
		const raw = localStorage.getItem(MOT_STORAGE_KEYS.VERIFIED);
		if(!raw) return false;
		const data = (function() { try { return JSON.parse(raw); } catch(e) { console.error('JSON parse error:', e); return null; } })();
		return !!(data && data.uid);
	}catch{
		return false;
	}
}
function getUserContext(){
	const uid = getOrCreateUserId();
	const verified = isUserVerified();
	return { uid, verified };
}

const REACTIONS = [
	{key:'like', label:'Gefällt mir'},
	{key:'celebrate', label:'Gefeliciteerd'},
	{key:'support', label:'Stützen'},
	{key:'love', label:'Gewaltig'},
	{key:'insightful', label:'Verheldernd'},
	{key:'curious', label:'Interessant'},
	{key:'entertainment', label:'Rappig'}
];

// Präsenz-/Auto-Connect-Konfiguration (Backend-Endpunkte anpassbar)
// In Cloudflare Pages/Workers-Setup: relative Route /api/presence
// Auf GitHub Pages: null (keine Serverless Functions)
let PRESENCE_API_BASE = (location.hostname.includes('github.io') || location.hostname.includes('github.com')) 
	? null 
	: '/api/presence';
window.PRESENCE_API_BASE = PRESENCE_API_BASE; // Global verfügbar machen
// D1-backed API base; in Produktion als Cloudflare Pages Function bereitgestellt
// Automatische Erkennung: Wenn lokal (file:// oder localhost ohne /api), dann null (keine API-Calls)
function detectVoucherApiBase() {
	// Wenn auf GitHub Pages, deaktiviere API-Calls (keine Serverless Functions)
	if (location.hostname.includes('github.io') || location.hostname.includes('github.com')) {
		console.warn('⚠️ GitHub Pages erkannt: API-Funktionen sind nicht verfügbar. Für volle Funktionalität deploye auf Cloudflare Pages.');
		return null;
	}
	// Wenn auf Cloudflare Pages (ts-portal.pages.dev oder ähnlich), verwende relative Pfade
	if (location.hostname.includes('pages.dev') || location.hostname.includes('workers.dev') || location.hostname.includes('cloudflare')) {
		return '/api';
	}
	// Wenn lokal (file:// oder localhost ohne API-Server), deaktiviere API-Calls
	if (location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
		// Prüfe, ob /api verfügbar ist (schneller Health-Check)
		return null; // Wird später dynamisch geprüft
	}
	// Standard: relative Pfade (für Cloudflare Pages)
	return '/api';
}
let VOUCHER_API_BASE = detectVoucherApiBase();
let MORTGAGE_API_BASE = null; // Wird dynamisch erkannt

// Dynamische API-Base-URL-Erkennung beim Laden
(async function initApiBase() {
	// Wenn GitHub Pages erkannt, KEINEN Health-Check machen (würde 404-Fehler produzieren)
	if (location.hostname.includes('github.io') || location.hostname.includes('github.com')) {
		VOUCHER_API_BASE = null;
		MORTGAGE_API_BASE = null;
		window.PRESENCE_API_BASE = null; // Auch Presence API deaktivieren
		console.warn('⚠️ GitHub Pages erkannt: Alle API-Funktionen sind deaktiviert. Für volle Funktionalität deploye auf Cloudflare Pages.');
		return;
	}
	
		if (VOUCHER_API_BASE === null) {
			// Versuche, /api zu erreichen (Health-Check) - NUR wenn nicht GitHub Pages
			try {
				const testRes = await fetch('/api/voucher/list?holderUid=test', { method: 'GET' });
				if (testRes.ok || testRes.status === 400) { // 400 ist OK, bedeutet dass API existiert
					VOUCHER_API_BASE = '/api';
					MORTGAGE_API_BASE = '/api'; // Mortgage API auf derselben Base
				} else {
					VOUCHER_API_BASE = null; // API nicht verfügbar
					MORTGAGE_API_BASE = null;
				}
			} catch (e) {
				VOUCHER_API_BASE = null; // API nicht verfügbar, deaktiviere API-Calls
				MORTGAGE_API_BASE = null;
				console.warn('Voucher API nicht verfügbar. Voucher-Funktionen sind deaktiviert. Für volle Funktionalität deploye auf Cloudflare Pages.');
			}
		} else {
			// Wenn VOUCHER_API_BASE bereits gesetzt ist (z.B. durch detectVoucherApiBase), setze auch MORTGAGE_API_BASE
			MORTGAGE_API_BASE = VOUCHER_API_BASE;
		}
})();
const HEARTBEAT_INTERVAL_MS = 25000;
const MATCH_INTERVAL_MS = 5000;
const TELEMETRY_ENDPOINT = '/api/telemetry';

/* Access control: public vs verified
   Offline-App will open portal with URL hash: #mot=TOKEN&ts=...&sig=...
   Portal verifies HMAC-SHA256(sig) over `${TOKEN}.${ts}` with shared secret name "MOT_ACCESS_TOKEN".
*/
const TOKEN_PARAM = 'mot';
const SIG_PARAM = 'sig';
const TS_PARAM = 'ts';
async function hmacSHA256Hex(key, data){
	const enc = new TextEncoder();
	const cryptoKey = await crypto.subtle.importKey('raw', enc.encode(key), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
	const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(data));
	return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function setVerifiedUI(on){
	document.body.classList.toggle('public-view', !on);
}
function updateConnectStatus(msg){
	const el = document.getElementById('connectStatus');
	if(el) el.textContent = msg;
}

// Token aus URL-Hash oder lokalem Speicher lesen (vom Offline-Manifest gesetzt)
function readManifestToken(){
	const p = parseHashParams();
	// Unterstützt sowohl alte Schlüssel (token/sig/ts) als auch die aktuellen (mot/ts[/sig])
	const token = p[TOKEN_PARAM] || p.token || null;
	const ts = p[TS_PARAM] || p.ts || null;
	const sig = p[SIG_PARAM] || p.sig || null;
	if(token && ts){
		return { token, sig, ts };
	}
	try{
		const raw = localStorage.getItem('mot_token');
		if(raw){
			const obj = (function() { try { return JSON.parse(raw); } catch(e) { console.error('JSON parse error:', e); return null; } })();
			if(obj && obj.token){
				return obj;
			}
		}
	}catch{/* still offline */}
	return null;
}

// Mit Backend verifizieren, wer dieser Thinker ist
async function verifyTokenWithBackend(tokenObj){
	if(!tokenObj || !tokenObj.token) return null;
	if(!PRESENCE_API_BASE) return null; // API nicht verfügbar
	try{
		const res = await fetch(`${PRESENCE_API_BASE}/verify`, {
			method:'POST',
			headers:{'Content-Type':'application/json'},
			body: JSON.stringify(tokenObj)
		});
		if(!res.ok) return null;
		const data = await res.json();
		if(!data || !data.thinker_id) return null;
		return data; // { thinker_id, pair_code? }
	}catch{
		return null;
	}
}

let currentIdentity = null;
let heartbeatTimer = null;
let matchTimer = null;
let currentRoomId = null;
let liveSocket = null;

function getEffectivePairCode(identity){
	const input = document.getElementById('pairCodeInput');
	const manual = input ? input.value.trim() : '';
	if(manual) return manual;
	if(identity && identity.pair_code) return String(identity.pair_code);
	return '';
}

function startPresenceHeartbeat(identity){
	if(!identity || !identity.thinker_id) return;
	currentIdentity = identity;
	if(heartbeatTimer) clearInterval(heartbeatTimer);

	const send = async (status='online')=>{
		if(!PRESENCE_API_BASE) return; // API nicht verfügbar
		try{
			const pair_code = getEffectivePairCode(identity);
			await fetch(`${PRESENCE_API_BASE}/heartbeat`, {
				method:'POST',
				headers:{'Content-Type':'application/json'},
				body: JSON.stringify({
					thinker_id: identity.thinker_id,
					pair_code,
					status
				})
			});
		}catch{/* offline oder Backend noch nicht aktiv */}
	};

	// sofort einen Heartbeat senden, dann zyklisch
	send('online');
	heartbeatTimer = setInterval(()=>send('online'), HEARTBEAT_INTERVAL_MS);

	// Beim Schließen optional "offline" melden
	window.addEventListener('beforeunload', ()=>send('offline'));

	// Wenn User den Pair-Code ändert, nächsten Heartbeat mit neuem Code senden
	const input = document.getElementById('pairCodeInput');
	if(input){
		input.addEventListener('input', ()=>{
			updateConnectStatus('Änderung übernommen. Warte auf zweiten Teilnehmer …');
			send('online');
		});
	}
}

function startMatchLoop(identity){
	if(!identity || !identity.thinker_id) return;
	if(matchTimer) clearInterval(matchTimer);

	const liveRoom = document.getElementById('liveRoom');
	const liveRoomInfo = document.getElementById('liveRoomInfo');

		const check = async ()=>{
		if(!PRESENCE_API_BASE) {
			updateConnectStatus('Presence-API nicht verfügbar. Bitte deploye auf Cloudflare Pages für volle Funktionalität.');
			return;
		}
		try{
			const pair_code = getEffectivePairCode(identity);
			if(!pair_code){
				updateConnectStatus('Optional: Raum-Stichwort eingeben, um automatisch verbunden zu werden.');
				return;
			}
			updateConnectStatus(`Warte auf zweiten Thinker mit Stichwort „${pair_code}“…`);
			const res = await fetch(`${PRESENCE_API_BASE}/match`, {
				method:'POST',
				headers:{'Content-Type':'application/json'},
				body: JSON.stringify({
					thinker_id: identity.thinker_id,
					pair_code
				})
			});
			if(!res.ok) return;
			const data = await res.json();
			if(data && data.room_id){
				if(currentRoomId === data.room_id) return;
				currentRoomId = data.room_id;
				updateConnectStatus(`Verbunden mit Raum „${data.room_id}“. Live-Raum geöffnet.`);
				if(liveRoom && liveRoomInfo){
					liveRoom.style.display = 'block';
					liveRoomInfo.textContent = `Du bist in Raum „${data.room_id}“ mit Stichwort „${pair_code}“ verbunden. Signaling-Server verbunden.`;
					initLiveChat(currentIdentity, data.room_id);
				}
			}
		}catch{
			// Backend noch nicht verfügbar – leise weiterprobieren
		}
	};

	check();
	matchTimer = setInterval(check, MATCH_INTERVAL_MS);
}

// Phase 1: Presence-Auto-Init - Automatische Verifizierung ohne Token
async function autoInitPresence(){
	// Prüfe ob bereits verifiziert
	if(currentIdentity && currentIdentity.thinker_id){
		startPresenceHeartbeat(currentIdentity);
		startMatchLoop(currentIdentity);
		return currentIdentity;
	}
	
	// Erstelle automatisch thinker_id falls nicht vorhanden
	const uid = getOrCreateUserId();
	
	// Versuche Token aus URL zu lesen
	const tokenObj = readManifestToken();
	if(tokenObj){
		const identity = await verifyTokenWithBackend(tokenObj);
		if(identity){
			setVerifiedUI(true);
			startPresenceHeartbeat(identity);
			startMatchLoop(identity);
			updateConnectStatus('Verifiziert. Warte auf zweiten Teilnehmer oder gib ein gemeinsames Raum-Stichwort ein.');
			return identity;
		}
	}
	
	// Fallback: Erstelle Identity ohne Backend-Verifikation (für lokale Entwicklung)
	const fallbackIdentity = {
		thinker_id: uid,
		pair_code: null
	};
	currentIdentity = fallbackIdentity;
	startPresenceHeartbeat(fallbackIdentity);
	startMatchLoop(fallbackIdentity);
	updateConnectStatus('Bereit. Gib ein gemeinsames Raum-Stichwort ein oder nutze einen Einladungslink.');
	return fallbackIdentity;
}

// Phase 2: One-Click-Match - Automatisches Matching aus URL-Parametern
async function autoConnectFromToken(){
	// Prüfe URL-Parameter für room/pair_code
	const urlParams = new URLSearchParams(window.location.search);
	const roomParam = urlParams.get('room') || urlParams.get('pair_code');
	
	// Wenn room-Parameter vorhanden, automatisch matchen
	if(roomParam){
		const identity = await autoInitPresence();
		if(identity){
			// Setze pair_code automatisch
			const pairCodeInput = document.getElementById('pairCodeInput');
			if(pairCodeInput){
				pairCodeInput.value = roomParam;
			}
			
			// Starte sofort Match-Loop
			updateConnectStatus(`Raum „${roomParam}“ wird beigetreten …`);
			
			// Warte kurz, dann prüfe Match
			setTimeout(async ()=>{
				if(PRESENCE_API_BASE){
					try{
						const res = await fetch(`${PRESENCE_API_BASE}/match`, {
							method:'POST',
							headers:{'Content-Type':'application/json'},
							body: JSON.stringify({
								thinker_id: identity.thinker_id,
								pair_code: roomParam
							})
						});
						if(res.ok){
							const data = await res.json();
							if(data && data.room_id){
								currentRoomId = data.room_id;
								updateConnectStatus(`Verbunden mit Raum „${data.room_id}“. Signaling-Server verbunden.`);
								if(currentIdentity){
									initLiveChat(currentIdentity, data.room_id);
								}
							}
						}
					}catch{
						// Backend nicht verfügbar - leise weiter
					}
				}
			}, 1000);
			
			return identity;
		}
	}
	
	// Normale Token-Verifizierung (wie vorher)
	const tokenObj = readManifestToken();
	if(!tokenObj){
		// Kein Token, aber Auto-Init trotzdem starten
		return await autoInitPresence();
	}
	const identity = await verifyTokenWithBackend(tokenObj);
	if(!identity){
		// Token-Verifizierung fehlgeschlagen, aber Auto-Init trotzdem starten
		return await autoInitPresence();
	}
	setVerifiedUI(true);
	startPresenceHeartbeat(identity);
	startMatchLoop(identity);
	updateConnectStatus('Verifiziert. Warte auf zweiten Teilnehmer oder gib ein gemeinsames Raum-Stichwort ein.');
	return identity;
}

// Live-Textkanal über WebSocket (Signaling-Server)
function initLiveChat(identity, roomId){
	const liveChat = document.getElementById('liveChat');
	const messagesEl = document.getElementById('liveChatMessages');
	const inputEl = document.getElementById('liveChatInput');
	const sendBtn = document.getElementById('liveChatSendBtn');

	if(!liveChat || !messagesEl || !inputEl || !sendBtn) return;

	// Vorherige Verbindung schließen
	if(liveSocket && liveSocket.readyState === WebSocket.OPEN){
		try{ liveSocket.close(); }catch{}
	}

	liveChat.style.display = 'block';
	messagesEl.innerHTML = '';

	// Automatische Signaling-URL-Erkennung
	let signalUrl = (document.getElementById('signalUrl')?.value || '').trim();
	
	// Wenn keine URL eingegeben, automatisch Cloudflare Pages WebSocket verwenden
	if (!signalUrl) {
		// Prüfe ob auf Cloudflare Pages
		if (location.hostname.includes('pages.dev') || location.hostname.includes('workers.dev') || location.hostname.includes('cloudflare')) {
			// Cloudflare Pages WebSocket-Endpunkt
			const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
			signalUrl = `${protocol}//${location.host}/ws`;
		} else if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
			// Lokaler Signaling-Server (signal-server.js)
			signalUrl = 'ws://localhost:3100/ws';
		} else if (location.hostname.includes('github.io') || location.hostname.includes('github.com')) {
			// GitHub Pages: WebSocket nicht verfügbar, deaktiviere
			appendChatSystem(messagesEl, '⚠️ WebSocket-Verbindungen sind auf GitHub Pages nicht verfügbar. Bitte deploye auf Cloudflare Pages für Live-Chat.');
			return;
		} else {
			// Andere Domains: Versuche Cloudflare Pages WebSocket (falls verfügbar)
			const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
			signalUrl = `${protocol}//${location.host}/ws`;
		}
	}
	
	// Speichere URL für später
	if (document.getElementById('signalUrl')) {
		document.getElementById('signalUrl').value = signalUrl;
	}

	let ws;
	try{
		ws = new WebSocket(signalUrl);
		liveSocket = ws;
	}catch(err){
		appendChatSystem(messagesEl, 'Verbindung zum Signaling-Server fehlgeschlagen: '+(err?.message||String(err)));
		// Auf GitHub Pages: Zeige hilfreiche Meldung
		if(location.hostname.includes('github.io') || location.hostname.includes('github.com')){
			appendChatSystem(messagesEl, '💡 Tipp: Für Live-Chat-Funktionalität deploye auf Cloudflare Pages.');
		}
		return;
	}
	
	// WebSocket Error-Handler für GitHub Pages
	ws.addEventListener('error', ()=>{
		if(location.hostname.includes('github.io') || location.hostname.includes('github.com')){
			appendChatSystem(messagesEl, '⚠️ WebSocket-Verbindung fehlgeschlagen. GitHub Pages unterstützt keine WebSocket-Verbindungen.');
		}
	});
	
	ws.addEventListener('open', ()=>{
		appendChatSystem(messagesEl, `Verbindung zum Signaling-Server hergestellt. Raum „${roomId}“ wird beigetreten …`);
		ws.send(JSON.stringify({
			type: 'join',
			room_id: roomId,
			thinker_id: identity?.thinker_id || null
		}));
	});

	ws.addEventListener('message', (event)=>{
		let msg;
		try{
			msg = (function() { try { return JSON.parse(event.data); } catch(e) { console.error('JSON parse error:', e); return null; } })();
		}catch{
			return;
		}
		if(!msg || msg.room_id !== roomId) return;

		if(msg.type === 'system'){
			appendChatSystem(messagesEl, `System: Teilnehmer-Event („${msg.event||'event'}“) im Raum.`);
			return;
		}
		if(msg.type === 'message'){
			const from = msg.from || 'Unbekannt';
			const text = msg.payload?.text || '';
			if(!text) return;
			appendChatMessage(messagesEl, from, text, msg.at);
			return;
		}
	});

	ws.addEventListener('close', ()=>{
		appendChatSystem(messagesEl, 'Verbindung zum Signaling-Server wurde geschlossen.');
	});
	ws.addEventListener('error', ()=>{
		appendChatSystem(messagesEl, 'Fehler auf der Signaling-Verbindung.');
	});

	function sendCurrent(){
		const text = (inputEl.value||'').trim();
		if(!text || !ws || ws.readyState !== WebSocket.OPEN) return;
		ws.send(JSON.stringify({
			type: 'message',
			room_id: roomId,
			thinker_id: identity?.thinker_id || null,
			payload: { text }
		}));
		appendChatMessage(messagesEl, 'Du', text, Date.now());
		inputEl.value = '';
	}

	sendBtn.onclick = sendCurrent;
	inputEl.onkeydown = (ev)=>{
		if(ev.key === 'Enter'){
			ev.preventDefault();
			sendCurrent();
		}
	};
}

function appendChatSystem(container, text){
	const div = document.createElement('div');
	div.className = 'live-chat-message';
	div.innerHTML = `<div class="meta">System</div><div>${e(text)}</div>`;
	container.appendChild(div);
	container.scrollTop = container.scrollHeight;
}

function appendChatMessage(container, from, text, at){
	const div = document.createElement('div');
	div.className = 'live-chat-message';
	const time = at ? new Date(at).toLocaleTimeString() : '';
	div.innerHTML = `<div class="meta">${e(from)} ${time? '· '+e(time):''}</div><div>${e(text)}</div>`;
	container.appendChild(div);
	container.scrollTop = container.scrollHeight;
}
async function tryAutoVerify(){
	const params = parseHashParams();
	const p = {
		token: params[TOKEN_PARAM] || params.token || '',
		sig: params[SIG_PARAM] || params.sig || '',
		ts: params[TS_PARAM] || params.ts || '',
		uid: params.uid || null
	};
	if(!p.token || !p.ts) return false;
	// Freshness check (5 minutes)
	const skew = Math.abs(Date.now() - Number(p.ts));
	if(!Number.isFinite(skew) || skew > 5*60*1000) return false;
	// Fall 1: Signatur vorhanden → klassischer HMAC-Check
	if(p.sig){
		const data = `${p.token}.${p.ts}`;
		const expect = await hmacSHA256Hex(p.token, data);
		if (expect === p.sig){
			setVerifiedUI(true);
			document.getElementById('token').value = p.token;
			markUserVerified({ uid: p.uid, mot: p.token, ts: p.ts, sig: p.sig });
			return true;
		}
		return false;
	}
	// Fall 2: Keine Signatur (Single-File/Offline-Download) → Token + Zeitfenster reichen
	setVerifiedUI(true);
	document.getElementById('token').value = p.token;
	markUserVerified({ uid: p.uid, mot: p.token, ts: p.ts, sig: null });
	return true;
}
document.getElementById('verifyBtn').addEventListener('click', async ()=>{
	const t = document.getElementById('token').value.trim();
	if(!t) return alert('Token eingeben.');
	// Manual verify = enable features (shared secret possession)
	setVerifiedUI(true);
});

/* Feed rendering */
const feed = document.getElementById('feed');
function renderFeed(db){
	feed.innerHTML = '';
	const posts = db?.posts||[];
	if(!posts.length){
		const empty = document.createElement('div');
		empty.className = 'pad';
		empty.innerHTML = `<div class="muted">Keine Beiträge geladen.</div>`;
		feed.appendChild(empty);
		return;
	}
	posts.forEach(p=>{
		const el = document.createElement('article');
		el.className = 'entry';
		el.innerHTML = `
			<h3>${e(p.title||'Ohne Titel')}</h3>
			<div class="meta">${new Date(p.createdAt).toLocaleString()} ${p.initials? '· '+e(p.initials):''} ${p.tags?.length? '· Tags: '+p.tags.map(e).join(', '):''}</div>
			<div class="content" style="margin-top:8px;white-space:pre-wrap">${e(p.content)}</div>
			<div class="reactions">
				${REACTIONS.map(r=>{
					const c = p.reactions?.[r.key]||0;
					return c? `<span class="reaction">${r.label} (${c})</span>` : '';
				}).join('')}
			</div>
			${p.comments?.length? `<div style="margin-top:10px">${p.comments.map(c=>`<div class="comment"><strong>${e(c.by||'Anon')}</strong>: ${e(c.text)} <span class="meta" style="margin-left:6px">${new Date(c.at).toLocaleString()}</span></div>`).join('')}</div>`:''}
		`;
		feed.appendChild(el);
	});
}
function e(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* Admin-Moderation Logik (lokal, ohne Backend) */
const verbergenBtn = document.getElementById('verbergenBtn');
const sichtbarBtn = document.getElementById('sichtbarBtn');
const statsBtn = document.getElementById('statsBtn');
const moderationScope = document.getElementById('moderationScope');
const moderationStatus = document.getElementById('moderationStatus');
if(verbergenBtn && moderationStatus && feed){
	verbergenBtn.addEventListener('click', ()=>{
		feed.classList.add('dimmed-feed');
		const scope = moderationScope?.value || 'local';
		moderationStatus.textContent = scope === 'session'
			? 'Beiträge im aktuellen View ausgeblendet (Sitzungs‑Scope, nur UI).'
			: 'Beiträge im aktuellen Browser ausgeblendet (nur lokale Ansicht).';
	});
}
if(sichtbarBtn && moderationStatus && feed){
	sichtbarBtn.addEventListener('click', ()=>{
		feed.classList.remove('dimmed-feed');
		moderationStatus.textContent = 'Beiträge wieder vollständig sichtbar (lokale Ansicht).';
	});
}
if(statsBtn && moderationStatus && feed){
	statsBtn.addEventListener('click', ()=>{
		const total = feed.querySelectorAll('.entry').length;
		moderationStatus.textContent = total
			? `Aktuelle Beiträge im Feed: ${total}.`
			: 'Aktuell sind keine Beiträge im Feed geladen.';
	});
}

// Psychologie / Telemetrie – einfacher Client
let telemetryQueue = [];
let telemetryTimer = null;

function enqueueTelemetry(ev){
	try{
		telemetryQueue.push(ev);
		if(telemetryQueue.length >= 10){
			flushTelemetry();
		}else if(!telemetryTimer){
			telemetryTimer = setTimeout(flushTelemetry, 3000);
		}
	}catch{/* ignore */}
}

async function flushTelemetry(){
	const batch = telemetryQueue;
	if(!batch.length) return;
	// Deaktiviere Telemetry auf GitHub Pages (keine API verfügbar)
	if (location.hostname.includes('github.io') || location.hostname.includes('github.com')) {
		telemetryQueue = [];
		if(telemetryTimer){
			clearTimeout(telemetryTimer);
			telemetryTimer = null;
		}
		return;
	}
	telemetryQueue = [];
	if(telemetryTimer){
		clearTimeout(telemetryTimer);
		telemetryTimer = null;
	}
	try{
		await fetch(TELEMETRY_ENDPOINT, {
			method:'POST',
			headers:{'Content-Type':'application/json'},
			body: JSON.stringify(batch)
		});
	}catch{/* offline / optional */}
}

function installBasicTelemetry(){
	const { uid } = getUserContext();
	const base = {
		path: window.location.pathname + window.location.hash,
		actorUid: uid
	};
	enqueueTelemetry({ type:'page.view', ...base, meta:{ ts: Date.now() } });

	// Einfache "Rage Click" Erkennung
	let lastClickTime = 0;
	let lastTargetKey = '';
	let clickCount = 0;

	document.addEventListener('click', (ev)=>{
		const now = Date.now();
		const target = ev.target;
		const key = target && target.closest ? (target.closest('[data-telemetry-key]')?.getAttribute('data-telemetry-key') || target.tagName) : (target.tagName || 'UNKNOWN');

		if(now - lastClickTime < 800 && key === lastTargetKey){
			clickCount++;
		}else{
			clickCount = 1;
			lastTargetKey = key;
		}
		lastClickTime = now;

		enqueueTelemetry({ type:'ui.click', ...base, meta:{ key, x: ev.clientX, y: ev.clientY } });

		if(clickCount >= 4){
			enqueueTelemetry({ type:'ui.rage_click', ...base, meta:{ key, count: clickCount } });
			clickCount = 0;
		}
	}, {capture:true});

	// Form-Abbrüche können später ergänzt werden; Platzhalter als Hinweis
}

/* Payload viewer */
const payloadBox = document.getElementById('payloadBox');
document.getElementById('payloadBtn').addEventListener('click', ()=>{
	payloadBox.hidden = !payloadBox.hidden;
});

/* Import JSON file */
const jsonFile = document.getElementById('jsonFile');
jsonFile.addEventListener('change', async ()=>{
	const f = jsonFile.files?.[0]; if(!f) return;
	const text = await f.text();
	try{
		const data = (function() { try { return JSON.parse(text); } catch(e) { console.error('JSON parse error:', e); return null; } })();
		if(!data || !Array.isArray(data.posts)) throw new Error('Ungültiges Format');
		renderFeed(data);
		payloadBox.hidden=false; payloadBox.textContent = JSON.stringify(data, null, 2);
	}catch(err){ alert('Import fehlgeschlagen: '+err.message); }
	jsonFile.value = '';
});

/* API fetch */
document.getElementById('fetchBtn').addEventListener('click', async ()=>{
	const url = document.getElementById('apiUrl').value.trim();
	if(!url) return alert('API URL angeben.');
	try{
		const res = await fetch(url, {headers:{'Accept':'application/json'}});
		const data = await res.json();
		renderFeed(data);
		payloadBox.hidden=false; payloadBox.textContent = JSON.stringify(data, null, 2);
	}catch(err){ alert('API Fehler: '+err.message); }
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
	renderFeed({posts:[]}); payloadBox.hidden=true; payloadBox.textContent='';
});

/* Live-Funktionen initialisieren */
document.getElementById('initLiveBtn').addEventListener('click', ()=>{
	// Prüfe ob verifiziert
	if (!currentIdentity || !currentIdentity.thinker_id) {
		alert('Bitte zuerst verifizieren (Token aus Offline-Forum oder manuell eingeben).');
		return;
	}
	
	// Prüfe ob room_id vorhanden
	if (!currentRoomId) {
		// Erstelle room_id aus pair_code oder verwende manuell eingegebene
		const pairCode = getEffectivePairCode(currentIdentity);
		const manualRoomId = document.getElementById('roomId')?.value?.trim();
		
		if (manualRoomId) {
			currentRoomId = manualRoomId;
		} else if (pairCode) {
			// Generiere room_id aus pair_code
			currentRoomId = `room-${pairCode}`;
		} else {
			// Fallback: Verwende thinker_id als room_id
			currentRoomId = `room-${currentIdentity.thinker_id}`;
		}
	}
	
	// Initialisiere Live-Chat
	initLiveChat(currentIdentity, currentRoomId);
	
	// Zeige Live-Raum
	const liveRoom = document.getElementById('liveRoom');
	if (liveRoom) {
		liveRoom.style.display = 'block';
	}
	
	const liveRoomInfo = document.getElementById('liveRoomInfo');
	if (liveRoomInfo) {
		liveRoomInfo.textContent = `Live-Raum „${currentRoomId}“ wurde initialisiert. Signaling-Server verbunden.`;
	}
});

/* Hidden Viewer, Medien & Datei-Transfer (UI-Stubs mit realen Aktionen) */
const loadHiddenBtn = document.getElementById('loadHiddenBtn');
const filePickInput = document.getElementById('filePick');
const filePickStatus = document.getElementById('filePickStatus');
const startMediaBtn = document.getElementById('startMediaBtn');
const stopMediaBtn = document.getElementById('stopMediaBtn');
const mediaStatus = document.getElementById('mediaStatus');
let mediaActive = false;

if(loadHiddenBtn){
	loadHiddenBtn.addEventListener('click', ()=>{
		const liveRoom = document.getElementById('liveRoom');
		if(liveRoom){
			liveRoom.style.display = 'block';
			const info = document.getElementById('liveRoomInfo');
			if(info){
				info.textContent = 'Hidden Viewer geöffnet. Sobald ein echter Raum aktiv ist, werden hier Live-Inhalte eingeblendet.';
			}
		}
	});
}
if(filePickInput && filePickStatus){
	filePickInput.addEventListener('change', ()=>{
		const files = Array.from(filePickInput.files || []);
		if(!files.length){
			filePickStatus.textContent = 'Noch keine Dateien ausgewählt.';
			return;
		}
		filePickStatus.textContent = `${files.length} Datei(en) ausgewählt – bereit für Upload zu einem R2-Endpunkt.`;
	});
}
function updateMediaStatus(){
	if(!mediaStatus) return;
	mediaStatus.textContent = mediaActive
		? 'Media-Demo aktiv (UI-Ebene). Ein echter Stream kann später an diese Steuerung andocken.'
		: 'Media-/Streams sind noch inaktiv.';
}
if(startMediaBtn){
	startMediaBtn.addEventListener('click', ()=>{
		mediaActive = true;
		updateMediaStatus();
	});
}
if(stopMediaBtn){
	stopMediaBtn.addEventListener('click', ()=>{
		mediaActive = false;
		updateMediaStatus();
	});
}

/* API/Signaling Presets (No‑Code Helfer) */
const apiPresetSel = document.getElementById('apiPreset');
const apiUrlInput = document.getElementById('apiUrl');
if(apiPresetSel && apiUrlInput){
	apiPresetSel.addEventListener('change', ()=>{
		const v = apiPresetSel.value;
		if(v === 'supabase'){
			apiUrlInput.value = 'https://DEIN-PROJEKT.supabase.co/rest/v1/manifest';
		}else if(v === 'firebase'){
			apiUrlInput.value = 'https://us-central1-DEIN-PROJEKT.cloudfunctions.net/manifestList';
		}else if(v === 'custom'){
			apiUrlInput.value = '';
			apiUrlInput.placeholder = 'Eigene API-URL (z. B. https://deine-seite.tld/api/manifest/list)';
		}
	});
}

const signalPresetSel = document.getElementById('signalPreset');
const signalUrlInput = document.getElementById('signalUrl');
if(signalPresetSel && signalUrlInput){
	signalPresetSel.addEventListener('change', ()=>{
		const v = signalPresetSel.value;
		if(v === 'cloudflare'){
			// Automatisch Cloudflare Pages WebSocket verwenden
			const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
			signalUrlInput.value = `${protocol}//${location.host}/ws`;
		}else if(v === 'local'){
			// Lokaler Signaling-Server
			signalUrlInput.value = 'ws://localhost:3100/ws';
		}else if(v === 'twilio'){
			signalUrlInput.value = 'wss://DEIN-TWILIO-SIGNALING-ENDPUNKT';
		}else if(v === 'ably'){
			signalUrlInput.value = 'wss://realtime.ably.io?key=DEIN-ABLY-SCHLUESSEL';
		}else if(v === 'custom'){
			signalUrlInput.value = '';
			signalUrlInput.placeholder = 'Eigene WSS-URL (z. B. wss://signaling.deine-seite.tld)';
		}
	});
}

/* Token-URL Generator (No‑Code) */
const genBaseTokenInput = document.getElementById('genBaseToken');
const generateUrlBtn = document.getElementById('generateUrlBtn');
const generatedUrlBox = document.getElementById('generatedUrl');
if(generateUrlBtn && genBaseTokenInput && generatedUrlBox){
	generateUrlBtn.addEventListener('click', async ()=>{
		const base = genBaseTokenInput.value.trim();
		if(!base){
			alert('Bitte zuerst ein Basis-Token eingeben.');
			return;
		}
		try{
			const ts = Date.now().toString();
			const data = `${base}.${ts}`;
			const sig = await hmacSHA256Hex(base, data);
			const url = new URL(window.location.href);
			url.hash = `mot=${encodeURIComponent(base)}&ts=${encodeURIComponent(ts)}&sig=${encodeURIComponent(sig)}`;
			generatedUrlBox.value = url.toString();
		}catch(err){
			generatedUrlBox.value = 'Fehler beim Erzeugen der URL: ' + (err?.message || String(err));
		}
	});
}

/* Live-Raum JSON Builder (No‑Code) */
const roomTypeSel = document.getElementById('roomType');
const roomIdInput = document.getElementById('roomId');
const permRead = document.getElementById('permRead');
const permSend = document.getElementById('permSend');
const permSign = document.getElementById('permSign');
const permUpload = document.getElementById('permUpload');
const buildRoomJsonBtn = document.getElementById('buildRoomJsonBtn');
const roomJsonBox = document.getElementById('roomJsonBox');
if(buildRoomJsonBtn && roomTypeSel && roomIdInput && roomJsonBox){
	buildRoomJsonBtn.addEventListener('click', ()=>{
		const id = roomIdInput.value.trim();
		if(!id){
			alert('Bitte eine Raum-ID eintragen (z. B. post-123 oder wabe A-2).');
			return;
		}
		const room = {
			type: roomTypeSel.value || 'text',
			roomId: id,
			permissions: {
				read: !!permRead?.checked,
				send: !!permSend?.checked,
				sign: !!permSign?.checked,
				upload: !!permUpload?.checked
			}
		};
		roomJsonBox.textContent = JSON.stringify({ rooms:[room] }, null, 2);
	});
}

// Voucher & Termine UI
let voucherMode = 'customer'; // 'customer' | 'issuer'
let selectedVoucher = null;
const voucherListEl = document.getElementById('voucherList');
const slotListEl = document.getElementById('slotList');
const slotCalendarEl = document.getElementById('slotCalendar');
const voucherModeCustomerBtn = document.getElementById('voucherModeCustomer');
const voucherModeIssuerBtn = document.getElementById('voucherModeIssuer');
const voucherRefreshBtn = document.getElementById('btnVoucherRefresh');
const voucherTemplateButtons = document.querySelectorAll('[data-voucher-template]');
const eventsMembershipsOutput = document.getElementById('eventsMembershipsOutput');
const machinesTableBody = document.getElementById('machinesTableBody');
const eventsMembershipsTableBody = document.getElementById('eventsMembershipsTableBody');
const myBookingsList = document.getElementById('myBookingsList');

function setVoucherMode(mode){
	voucherMode = mode === 'issuer' ? 'issuer' : 'customer';
	if(voucherModeCustomerBtn && voucherModeIssuerBtn){
		if(voucherMode === 'customer'){
			voucherModeCustomerBtn.classList.add('btn');
			voucherModeCustomerBtn.classList.remove('alt');
			voucherModeIssuerBtn.classList.add('alt');
		}else{
			voucherModeIssuerBtn.classList.add('btn');
			voucherModeIssuerBtn.classList.remove('alt');
			voucherModeCustomerBtn.classList.add('alt');
		}
	}
	loadVouchers();
}

async function loadVouchers(){
	if(!voucherListEl) return;
	if(!VOUCHER_API_BASE) {
		voucherListEl.innerHTML = '<div class="muted">Voucher-API nicht verfügbar. Bitte deploye auf Cloudflare Pages für volle Funktionalität.</div>';
		return;
	}
	const { uid } = getUserContext();
	let url = `${VOUCHER_API_BASE}/voucher/list`;
	const params = new URLSearchParams();
	if(voucherMode === 'issuer'){
		params.set('issuerUid', uid);
	}else{
		params.set('holderUid', uid);
	}
	url += `?${params.toString()}`;
	voucherListEl.innerHTML = '<div class="muted">Lade Vouchers …</div>';
	slotListEl && (slotListEl.innerHTML = '');
	selectedVoucher = null;
	try{
		const res = await fetch(url);
		if(!res.ok) {
			voucherListEl.innerHTML = `<div class="muted">Fehler beim Laden: ${res.status} ${res.statusText}</div>`;
			return;
		}
		const data = await res.json();
		const items = data.items || [];
		if(!items.length){
			voucherListEl.innerHTML = '<div class="muted">Keine Vouchers gefunden.</div>';
			return;
		}
		voucherListEl.innerHTML = '';
		items.forEach(v => {
			const card = document.createElement('div');
			card.className = 'voucher-card';
			card.dataset.voucherId = v.voucherId;
			const statusClass = `status-${(v.status||'').toLowerCase()}`;
			const priceText = v.price && typeof v.price.amount === 'number'
				? `${(v.price.amount/100).toFixed(2)} ${(v.price.currency||'').toUpperCase()}`
				: '';
			card.innerHTML = `
				<div class="voucher-card-header">
					<div>
						<div style="font-size:13px;font-weight:600;">${e(v.title || v.serviceType || v.voucherId)}</div>
						<div class="voucher-meta">
							${v.serviceType ? e(v.serviceType) : ''}${priceText ? ' · '+e(priceText):''}
						</div>
					</div>
					<span class="voucher-badge ${statusClass}">${e(v.status || '—')}</span>
				</div>
				<div class="voucher-meta">
					Gültig: ${(v.validFrom||'').slice(0,10)} – ${(v.validUntil||'').slice(0,10) || 'offen'}
				</div>
			`;
			card.addEventListener('click', ()=> {
				selectedVoucher = v;
				loadSlotsForVoucher(v);
			});
			voucherListEl.appendChild(card);
		});
	}catch(err){
		voucherListEl.innerHTML = `<div class="muted">Fehler beim Laden: ${e(err?.message||String(err))}</div>`;
	}
}

async function loadSlotsForVoucher(voucher){
	if(!slotListEl || !voucher || !voucher.voucherId) return;
	if(!VOUCHER_API_BASE) {
		slotListEl.innerHTML = '<div class="muted">Voucher-API nicht verfügbar. Bitte deploye auf Cloudflare Pages für volle Funktionalität.</div>';
		if(slotCalendarEl) slotCalendarEl.innerHTML = '';
		return;
	}
	slotListEl.innerHTML = '<div class="muted">Lade verfügbare Slots …</div>';
	if(slotCalendarEl) slotCalendarEl.innerHTML = '';
	try{
		const res = await fetch(`${VOUCHER_API_BASE}/slots/available?voucherId=${encodeURIComponent(voucher.voucherId)}`);
		if(!res.ok) {
			slotListEl.innerHTML = `<div class="muted">Fehler beim Laden der Slots: ${res.status} ${res.statusText}</div>`;
			return;
		}
		const data = await res.json();
		const items = data.items || [];
		if(!items.length){
			slotListEl.innerHTML = '<div class="muted">Keine freien Slots verfügbar.</div>';
			if(slotCalendarEl){
				slotCalendarEl.innerHTML = '<div class="slot-calendar-day"><span>–</span><span class="slot-calendar-badges">Keine Slots im Kalender.</span></div>';
			}
			return;
		}
		slotListEl.innerHTML = '';
		items.forEach(slot => {
			const div = document.createElement('div');
			div.className = 'slot-item';
			const start = new Date(slot.start);
			const end = new Date(slot.end);
			div.innerHTML = `
				<div>
					<div>${start.toLocaleDateString()} · ${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} – ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
					<div class="voucher-meta">${e(voucher.title || voucher.serviceType || voucher.voucherId)}</div>
				</div>
				<button class="btn alt" type="button">Buchen</button>
			`;
			const btn = div.querySelector('button');
			btn.addEventListener('click', ()=> bookSlot(voucher, slot));
			slotListEl.appendChild(div);
		});
		if(slotCalendarEl){
			renderSlotCalendar(items);
		}
	}catch(err){
		slotListEl.innerHTML = `<div class="muted">Fehler beim Laden der Slots: ${e(err?.message||String(err))}</div>`;
		if(slotCalendarEl){
			slotCalendarEl.innerHTML = '';
		}
	}
}

async function bookSlot(voucher, slot){
	if(!voucher || !slot) return;
	if(!VOUCHER_API_BASE) {
		alert('Voucher-API nicht verfügbar. Bitte deploye auf Cloudflare Pages für volle Funktionalität.');
		return;
	}
	if(!confirm('Diesen Termin wirklich buchen?')) return;
	const { uid } = getUserContext();
	try{
		const res = await fetch(`${VOUCHER_API_BASE}/voucher/book`, {
			method:'POST',
			headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
			body: JSON.stringify({
				voucherId: voucher.voucherId,
				slotId: slot.slotId,
				holderUid: uid
			})
		});
		const data = await res.json();
		if(!res.ok || !data.ok){
			alert('Buchung fehlgeschlagen: ' + (data.error || res.statusText));
			return;
		}
		alert('Termin gebucht.\n\nDatum: ' + new Date(slot.start).toLocaleString());
		// Listen aktualisieren: Vouchers, Slots, vertikale Konsolen & persönliche Buchungen
		loadVouchers();
		slotListEl && (slotListEl.innerHTML = '');
		loadVerticalConsoles();
		loadEventsMembershipsOverview();
		loadMyBookings();
	}catch(err){
		alert('Fehler bei der Buchung: ' + (err?.message || String(err)));
	}
}
const VOUCHER_TEMPLATES = {
	consulting: {
		serviceType: 'consulting.session',
		title: 'Beratung 60 Minuten',
		description: 'Individuelle Beratungs‑Session (Video, Telefon oder Wabenraum).',
		durationMinutes: 60
	},
	therapy: {
		serviceType: 'therapy.session',
		title: 'Therapie‑/Coaching‑Session 50 Minuten',
		description: 'Geschützter Raum für Therapie oder Coaching, einmaliger Termin.',
		durationMinutes: 50
	},
	viewing: {
		serviceType: 'realestate.viewing',
		title: 'Haus‑/Wohnungsbesichtigung',
		description: 'Besichtigungstermin für eine Immobilie mit definierter Zeitspanne.',
		durationMinutes: 45
	},
	machine: {
		serviceType: 'machine.timeslot',
		title: 'Maschinenzeit Slot',
		description: 'Nutzung einer Maschine oder eines Studios im Stunden‑Takt.',
		durationMinutes: 60
	},
	membership: {
		serviceType: 'membership.access',
		title: 'Mitgliedschafts‑Voucher',
		description: 'Zugangsrecht zu einem geschlossenen Bereich (z. B. Community oder Club).',
		durationMinutes: 60*24
	}
};
const DEFAULT_VOUCHER_TEMPLATE_KEYS = ['consulting','therapy','viewing','machine','membership'];
async function issueVoucherTemplate(templateKey){
	const tpl = VOUCHER_TEMPLATES[templateKey];
	if(!tpl) return;
	if(!VOUCHER_API_BASE){
		alert('Voucher‑API ist nicht konfiguriert.');
		return;
	}
	const { uid } = getUserContext();
	const now = new Date();
	const validFrom = now.toISOString();
	const validUntil = new Date(now.getTime() + 7*24*60*60*1000).toISOString();
	const body = {
		issuerUid: uid,
		...tpl,
		validFrom,
		validUntil,
		transferable: true,
		terms: { template: templateKey }
	};
	try{
		if (!VOUCHER_API_BASE) {
			alert('Voucher‑API ist nicht verfügbar. Bitte deploye auf Cloudflare Pages für volle Funktionalität.');
			return;
		}
		const res = await fetch(`${VOUCHER_API_BASE}/voucher/issue`, {
			method:'POST',
			headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
			body: JSON.stringify(body)
		});
		if (!res.ok) {
			const errorText = await res.text().catch(() => res.statusText);
			let errorMsg = `HTTP ${res.status}: ${errorText}`;
			try {
				const errorData = (function() { try { return JSON.parse(errorText); } catch(e) { console.error('JSON parse error:', e); return null; } })();
				if (errorData.error) errorMsg = errorData.error;
			} catch {}
			alert('Voucher‑Vorlage konnte nicht ausgestellt werden: ' + errorMsg);
			// Fehler an Autofix melden
			if (window.enqueueError) {
				window.enqueueError(new Error(errorMsg), { type: 'voucher_issue_error', templateKey });
			}
			return;
		}
		const data = await res.json();
		if(!data || !data.ok){
			const errorMsg = data?.error || 'Unbekannter Fehler';
			alert('Voucher‑Vorlage konnte nicht ausgestellt werden: ' + errorMsg);
			// Fehler an Autofix melden
			if (window.enqueueError) {
				window.enqueueError(new Error(errorMsg), { type: 'voucher_issue_error', templateKey });
			}
			return;
		}
		alert('Voucher aus Vorlage erstellt.');
		loadVouchers();
	}catch(err){
		const errorMsg = err?.message || String(err);
		alert('Fehler beim Ausstellen der Vorlage: ' + errorMsg);
		// Fehler an Autofix melden
		if (window.enqueueError) {
			window.enqueueError(err, { type: 'voucher_issue_error', templateKey });
		}
	}
}

async function ensureDefaultVouchersForIssuer(){
	// Autopilot: Wenn dieser Browser noch nie Standard-Voucher ausgestellt hat,
	// einmalig die wichtigsten Templates erzeugen, damit der User sofort echte Daten sieht.
	try{
		if(!VOUCHER_API_BASE) return;
		if(localStorage.getItem('mot_default_vouchers_issued_v1')) return;
		const { uid } = getUserContext();
		const res = await fetch(`${VOUCHER_API_BASE}/voucher/list?issuerUid=${encodeURIComponent(uid)}`, {
			headers:{ 'Accept':'application/json' }
		});
		const data = await res.json();
		const items = data.items || [];
		if(items.length > 0) return; // Es gibt schon Vouchers, nichts tun

		for(const key of DEFAULT_VOUCHER_TEMPLATE_KEYS){
			await issueVoucherTemplate(key);
		}
		localStorage.setItem('mot_default_vouchers_issued_v1', '1');
	}catch{
		// leise scheitern, Autopilot ist optional
	}
}
function renderSlotCalendar(slots){
	if(!slotCalendarEl) return;
	if(!slots || !slots.length){
		slotCalendarEl.innerHTML = '<div class="slot-calendar-day"><span>–</span><span class="slot-calendar-badges">Keine Slots im Kalender.</span></div>';
		return;
	}
	const byDay = new Map();
	for(const s of slots){
		const d = new Date(s.start);
		if(Number.isNaN(d.getTime())) continue;
		const key = d.toISOString().slice(0,10);
		if(!byDay.has(key)) byDay.set(key, []);
		byDay.get(key).push(s);
	}
	const days = Array.from(byDay.entries()).sort(([a],[b])=> a<b?-1:a>b?1:0);
	slotCalendarEl.innerHTML = '';
	for(const [day, list] of days){
		const dayEl = document.createElement('div');
		dayEl.className = 'slot-calendar-day';
		const left = document.createElement('span');
		left.textContent = new Date(day).toLocaleDateString();
		const right = document.createElement('span');
		right.className = 'slot-calendar-badges';
		list.slice(0,6).forEach(s=>{
			const t = new Date(s.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
			const b = document.createElement('span');
			b.textContent = t;
			b.style.border = '1px solid var(--border)';
			b.style.borderRadius = '999px';
			b.style.padding = '1px 6px';
			right.appendChild(b);
		});
		if(list.length>6){
			const more = document.createElement('span');
			more.textContent = `+${list.length-6}`;
			more.style.opacity = '0.7';
			right.appendChild(more);
		}
		dayEl.appendChild(left);
		dayEl.appendChild(right);
		slotCalendarEl.appendChild(dayEl);
	}
}
async function loadEventsMembershipsOverview(){
	if(!eventsMembershipsOutput || !VOUCHER_API_BASE) return;
	const { uid } = getUserContext();
	let text = '';
	try{
		const url = `${VOUCHER_API_BASE}/voucher/list?issuerUid=${encodeURIComponent(uid)}`;
		const res = await fetch(url, { headers:{ 'Accept':'application/json' } });
		const data = await res.json();
		const items = data.items || [];
		const relevantTypes = ['consulting.session','therapy.session','membership.access'];
		const relevant = items.filter(v => relevantTypes.includes(v.serviceType));
		if(!relevant.length){
			eventsMembershipsOutput.textContent = 'Keine Events oder Membership‑Vouchers gefunden (als Aussteller).';
			return;
		}
		const byType = {};
		for(const v of relevant){
			const t = v.serviceType || 'unknown';
			if(!byType[t]) byType[t] = [];
			byType[t].push(v);
		}
		text += 'Übersicht pro Typ (als Aussteller):\n\n';
		for(const [type,list] of Object.entries(byType)){
			text += `• ${type} – ${list.length} Voucher\n`;
		}
		text += '\nDetails:\n';
		for(const v of relevant){
			text += `- ${v.voucherId} | ${v.title || v.serviceType} | Status: ${v.status || '—'} | Gültig: ${(v.validFrom||'').slice(0,10)} – ${(v.validUntil||'').slice(0,10) || 'offen'}\n`;
		}
		eventsMembershipsOutput.textContent = text;
	}catch(err){
		eventsMembershipsOutput.textContent = 'Fehler beim Laden der Übersicht: ' + (err?.message || String(err));
	}
}

async function loadMyBookings(){
	if(!myBookingsList || !VOUCHER_API_BASE) return;
	const { uid } = getUserContext();
	myBookingsList.innerHTML = '<div class="muted">Lade deine Buchungen …</div>';
	try{
		const res = await fetch(`${VOUCHER_API_BASE}/voucher/bookings?holderUid=${encodeURIComponent(uid)}`, {
			headers:{ 'Accept':'application/json' }
		});
		const data = await res.json();
		const items = data.items || [];
		if(!items.length){
			myBookingsList.innerHTML = '<div class="muted">Keine Buchungen gefunden.</div>';
			return;
		}
		myBookingsList.innerHTML = '';
		items.forEach(b=>{
			const row = document.createElement('div');
			row.className = 'slot-item';
			const start = b.slotStart ? new Date(b.slotStart) : null;
			const end = b.slotEnd ? new Date(b.slotEnd) : null;
			const range = (start && end)
				? `${start.toLocaleDateString()} · ${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} – ${end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
				: '—';
			row.innerHTML = `
				<div>
					<div>${e(range)}</div>
					<div class="voucher-meta">Voucher: ${e(b.voucherId || '—')}</div>
				</div>
				<span class="voucher-badge status-${(b.status||'').toLowerCase()}">${e(b.status || '—')}</span>
			`;
			myBookingsList.appendChild(row);
		});
	}catch(err){
		myBookingsList.innerHTML = '<div class="muted">Fehler beim Laden deiner Buchungen: '+e(err?.message||String(err))+'</div>';
	}
}

async function loadVerticalConsoles(){
	if(!machinesTableBody && !eventsMembershipsTableBody) return;
	if(!VOUCHER_API_BASE) {
		if(machinesTableBody) machinesTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Voucher-API nicht verfügbar.</td></tr>';
		if(eventsMembershipsTableBody) eventsMembershipsTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Voucher-API nicht verfügbar.</td></tr>';
		return;
	}
	const { uid } = getUserContext();
	try{
		const url = `${VOUCHER_API_BASE}/voucher/list?issuerUid=${encodeURIComponent(uid)}`;
		const res = await fetch(url, { headers:{ 'Accept':'application/json' } });
		const data = await res.json();
		const items = data.items || [];

		const machines = items.filter(v => v.serviceType === 'machine.timeslot');
		const eventTypes = ['consulting.session','therapy.session','realestate.viewing'];
		const events = items.filter(v => eventTypes.includes(v.serviceType));
		const memberships = items.filter(v => v.serviceType === 'membership.access');

		if(machinesTableBody){
			if(!machines.length){
				machinesTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Noch keine Maschinen‑Vouchers gefunden.</td></tr>';
			}else{
				machinesTableBody.innerHTML = machines.map(v=>{
					const priceText = v.price && typeof v.price.amount === 'number'
						? `${(v.price.amount/100).toFixed(2)} ${(v.price.currency||'').toUpperCase()}`
						: '—';
					const period = `${(v.validFrom||'').slice(0,10)} – ${(v.validUntil||'').slice(0,10) || 'offen'}`;
					// Standort wird aktuell aus terms.location oder terms.site gelesen (wenn vorhanden)
					const location = (v.terms && (v.terms.location || v.terms.site)) || '—';
					return `<tr>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.title || 'Maschinenzeit')}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(location)}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(priceText)}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.status || '—')} (${e(period)})</td>
					</tr>`;
				}).join('');
			}
		}

		if(eventsMembershipsTableBody){
			const combined = [...events, ...memberships];
			if(!combined.length){
				eventsMembershipsTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Noch keine Events/Memberships gefunden.</td></tr>';
			}else{
				eventsMembershipsTableBody.innerHTML = combined.map(v=>{
					const period = `${(v.validFrom||'').slice(0,10)} – ${(v.validUntil||'').slice(0,10) || 'offen'}`;
					return `<tr>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.serviceType || '—')}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.title || '')}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.status || '—')}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(period)}</td>
					</tr>`;
				}).join('');
			}
		}
	}catch(err){
		if(machinesTableBody){
			machinesTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Fehler beim Laden der Maschinen‑Konsole: '+e(err?.message||String(err))+'</td></tr>';
		}
		if(eventsMembershipsTableBody){
			eventsMembershipsTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Fehler beim Laden der Events/Memberships‑Konsole: '+e(err?.message||String(err))+'</td></tr>';
		}
	}
}
// Hypotheken-Demo-Modul
const mortgageOutput = document.getElementById('mortgageOutput');
const btnLoadApplications = document.getElementById('btnLoadApplications');
const btnLoadOffers = document.getElementById('btnLoadOffers');
const btnNewApplication = document.getElementById('btnNewApplication');

async function loadMortgageApplications(){
	if(!mortgageOutput) return;
	if(!MORTGAGE_API_BASE) {
		mortgageOutput.textContent = 'Mortgage-API ist nicht verfügbar. Bitte deploye auf Cloudflare Pages für volle Funktionalität.';
		return;
	}
	const { uid } = getUserContext();
	try{
		const res = await fetch(`${MORTGAGE_API_BASE}/mortgage/application-list?role=borrower`, {
			headers: {
				'Accept':'application/json',
				'X-MOT-User': uid
			}
		});
		if(!res.ok) {
			mortgageOutput.textContent = `Fehler beim Laden: ${res.status} ${res.statusText}`;
			return;
		}
		const data = await res.json();
		mortgageOutput.textContent = JSON.stringify(data, null, 2);
	}catch(err){
		mortgageOutput.textContent = 'Fehler beim Laden der Anfragen: ' + (err?.message || String(err));
	}
}

async function loadMortgageOffers(){
	if(!mortgageOutput) return;
	if(!MORTGAGE_API_BASE) {
		mortgageOutput.textContent = 'Mortgage-API ist nicht verfügbar. Bitte deploye auf Cloudflare Pages für volle Funktionalität.';
		return;
	}
	const { uid } = getUserContext();
	try{
		const res = await fetch(`${MORTGAGE_API_BASE}/mortgage/offer-list?role=borrower`, {
			headers: {
				'Accept':'application/json',
				'X-MOT-User': uid
			}
		});
		if(!res.ok) {
			mortgageOutput.textContent = `Fehler beim Laden: ${res.status} ${res.statusText}`;
			return;
		}
		const data = await res.json();
		mortgageOutput.textContent = JSON.stringify(data, null, 2);
	}catch(err){
		mortgageOutput.textContent = 'Fehler beim Laden der Angebote: ' + (err?.message || String(err));
	}
}

async function createExampleMortgageApplication(){
	if(!mortgageOutput) return;
	if(!MORTGAGE_API_BASE) {
		alert('Mortgage-API ist nicht verfügbar. Bitte deploye auf Cloudflare Pages für volle Funktionalität.');
		return;
	}
	const { uid } = getUserContext();
	const example = {
		propertyId: 'house-123',
		desiredLoan: { amount: 36000000, currency: 'EUR' },
		desiredDurationYears: 20,
		desiredRateType: 'fixed',
		maxInterestRate: 0.04,
		meta: {
			employmentStatus: 'employee',
			netIncomeMonthly: 380000,
			otherLoans: []
		}
	};
	try{
		const res = await fetch(`${MORTGAGE_API_BASE}/mortgage/application`, {
			method:'POST',
			headers: {
				'Content-Type':'application/json',
				'Accept':'application/json',
				'X-MOT-User': uid
			},
			body: JSON.stringify(example)
		});
		if(!res.ok) {
			mortgageOutput.textContent = `Fehler beim Erstellen: ${res.status} ${res.statusText}`;
			return;
		}
		const data = await res.json();
		mortgageOutput.textContent = JSON.stringify(data, null, 2);
	}catch(err){
		mortgageOutput.textContent = 'Fehler beim Erzeugen der Beispiel-Anfrage: ' + (err?.message || String(err));
	}
}

/* Zero-Input-Flow: Quick Action Buttons Setup */
function setupQuickActionButtons(){
	const quickCallBtn = document.getElementById('quickCallBtn');
	const quickChatBtn = document.getElementById('quickChatBtn');
	const quickGroupBtn = document.getElementById('quickGroupBtn');
	
	if(quickCallBtn){
		quickCallBtn.addEventListener('click', async ()=>{
			if (!currentIdentity || !currentIdentity.thinker_id) {
				alert('Bitte zuerst verifizieren (Token aus Offline-Forum oder manuell eingeben).');
				return;
			}
			// Generiere room_id für Call
			if (!currentRoomId) {
				const pairCode = getEffectivePairCode(currentIdentity);
				currentRoomId = pairCode ? `room-${pairCode}` : `room-${currentIdentity.thinker_id}`;
			}
			// Initialisiere Video-Call (UI-Stub, später echte WebRTC-Integration)
			alert(`📞 Call wird gestartet für Raum: ${currentRoomId}\n\nHinweis: Video-Call-Funktionalität wird später mit WebRTC integriert.`);
			initLiveChat(currentIdentity, currentRoomId);
		});
	}
	
	if(quickChatBtn){
		quickChatBtn.addEventListener('click', async ()=>{
			if (!currentIdentity || !currentIdentity.thinker_id) {
				alert('Bitte zuerst verifizieren (Token aus Offline-Forum oder manuell eingeben).');
				return;
			}
			// Generiere room_id für Chat
			if (!currentRoomId) {
				const pairCode = getEffectivePairCode(currentIdentity);
				currentRoomId = pairCode ? `room-${pairCode}` : `room-${currentIdentity.thinker_id}`;
			}
			// Initialisiere Text-Chat
			initLiveChat(currentIdentity, currentRoomId);
			const liveRoom = document.getElementById('liveRoom');
			if (liveRoom) {
				liveRoom.style.display = 'block';
			}
			const liveRoomInfo = document.getElementById('liveRoomInfo');
			if (liveRoomInfo) {
				liveRoomInfo.textContent = `💬 Chat-Raum „${currentRoomId}“ wurde gestartet.`;
			}
		});
	}
	
	if(quickGroupBtn){
		quickGroupBtn.addEventListener('click', async ()=>{
			if (!currentIdentity || !currentIdentity.thinker_id) {
				alert('Bitte zuerst verifizieren (Token aus Offline-Forum oder manuell eingeben).');
				return;
			}
			// Generiere room_id für Gruppe
			if (!currentRoomId) {
				const pairCode = getEffectivePairCode(currentIdentity);
				currentRoomId = pairCode ? `group-${pairCode}` : `group-${currentIdentity.thinker_id}`;
			}
			// Initialisiere Gruppen-Session
			initLiveChat(currentIdentity, currentRoomId);
			const liveRoom = document.getElementById('liveRoom');
			if (liveRoom) {
				liveRoom.style.display = 'block';
			}
			const liveRoomInfo = document.getElementById('liveRoomInfo');
			if (liveRoomInfo) {
				liveRoomInfo.textContent = `👥 Gruppen-Session „${currentRoomId}“ wurde gestartet.`;
			}
		});
	}
}

/* Anti copy for public viewers (soft) */
window.addEventListener('contextmenu', (e)=>{ if(document.body.classList.contains('public-view')) e.preventDefault(); }, {capture:true});
window.addEventListener('keydown', (e)=>{
	if(!document.body.classList.contains('public-view')) return;
	if((e.ctrlKey||e.metaKey)&&['c','x','s','p'].includes(e.key.toLowerCase())) e.preventDefault();
}, {capture:true});

/* UX-Überarbeitung: Navigation & Kommunikations-Cockpit */
let expertModeActive = false;
document.getElementById('navExpert')?.addEventListener('click', ()=>{
	expertModeActive = !expertModeActive;
	const expertDiv = document.getElementById('expertMode');
	if(expertDiv) expertDiv.style.display = expertModeActive ? 'block' : 'none';
	const navExpert = document.getElementById('navExpert');
	if(navExpert) navExpert.textContent = expertModeActive ? '⚙️ Expertenmodus' : '⚙️';
});

// Navigation-Buttons
document.getElementById('navHome')?.addEventListener('click', ()=> {
	document.getElementById('communicationCockpit')?.scrollIntoView({behavior:'smooth'});
});
document.getElementById('navContacts')?.addEventListener('click', ()=> {
	alert('Kontakte-Bereich wird später implementiert');
});
document.getElementById('navRooms')?.addEventListener('click', ()=> {
	window.location.href = './honeycomb.html';
});
document.getElementById('navDocuments')?.addEventListener('click', ()=> {
	window.location.href = './legal-hub.html';
});
document.getElementById('navFinance')?.addEventListener('click', ()=> {
	window.location.href = './TELBANK/index.html';
});

// Kommunikations-Cockpit Buttons
document.getElementById('actionMessage')?.addEventListener('click', ()=> {
	showMessageComposer();
});
document.getElementById('actionCall')?.addEventListener('click', ()=> {
	const quickCallBtn = document.getElementById('quickCallBtn');
	if(quickCallBtn) quickCallBtn.click();
});
document.getElementById('actionFile')?.addEventListener('click', ()=> {
	const filePick = document.getElementById('filePick');
	if(filePick) filePick.click();
});
document.getElementById('actionAppointment')?.addEventListener('click', ()=> {
	showLifeTemplate('consulting');
});
document.getElementById('actionContract')?.addEventListener('click', ()=> {
	window.location.href = './legal-hub.html';
});
document.getElementById('actionMore')?.addEventListener('click', ()=> {
	const lifeTemplates = document.getElementById('lifeTemplates');
	if(lifeTemplates) lifeTemplates.style.display = lifeTemplates.style.display === 'none' ? 'block' : 'none';
});

// Lebenslagen-Vorlagen
document.querySelectorAll('[data-template]').forEach(btn => {
	btn.addEventListener('click', ()=> {
		showLifeTemplate(btn.dataset.template);
	});
});

function showMessageComposer(){
	const composer = document.createElement('div');
	composer.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;z-index:10000;min-width:400px;max-width:90vw;';
	composer.innerHTML = `
		<h3 style="margin:0 0 12px;">Nachricht senden</h3>
		<input type="text" id="msgTo" placeholder="An: Kontakt/Gruppe wählen" style="width:100%;padding:8px;margin-bottom:8px;background:#0b0f14;border:1px solid var(--border);border-radius:8px;color:var(--ink);">
		<textarea id="msgText" placeholder="Nachricht..." style="width:100%;min-height:120px;padding:8px;margin-bottom:8px;background:#0b0f14;border:1px solid var(--border);border-radius:8px;color:var(--ink);resize:vertical;"></textarea>
		<div style="display:flex;gap:8px;justify-content:flex-end;">
			<button class="btn alt" onclick="this.closest('div').remove()">Abbrechen</button>
			<button class="btn" onclick="sendMessage()">Senden</button>
		</div>
	`;
	document.body.appendChild(composer);
	setTimeout(()=> document.getElementById('msgTo')?.focus(), 100);
}

window.sendMessage = function(){
	const to = document.getElementById('msgTo')?.value || 'Öffentlich';
	const text = document.getElementById('msgText')?.value;
	if(!text) return alert('Bitte eine Nachricht eingeben.');
	// Hier würde die Nachricht gesendet werden
	alert(`Nachricht an ${to} gesendet:\n\n${text}`);
	document.querySelector('[style*="position:fixed"]')?.remove();
};

function showLifeTemplate(template){
	const templates = {
		sell: {title:'Verkaufen / Angebot', fields:['Artikel/Dienstleistung','Preis','Beschreibung']},
		birth: {title:'Neue Geburt feiern', fields:['Name','Datum','Nachricht']},
		condolence: {title:'Trauer & Kondolenz', fields:['An','Nachricht']},
		consulting: {title:'Beratung/Coaching buchen', fields:['An','Thema','Datum/Uhrzeit']},
		realestate: {title:'Immobilie/Haus anfragen', fields:['An','Ort','Budget','Größe']},
		machine: {title:'Maschinenzeit buchen', fields:['Maschine/Studio','Datum','Uhrzeit']},
		membership: {title:'Mitgliedschaft starten', fields:['Community/Verein','Nachricht']}
	};
	const tpl = templates[template];
	if(!tpl) return;
	showMessageComposer();
	setTimeout(()=> {
		document.getElementById('msgTo').value = '';
		document.getElementById('msgText').value = `Vorlage: ${tpl.title}\n\n${tpl.fields.map(f=>f+': ').join('\n')}`;
	}, 100);
}

// Feedback-Button
document.getElementById('feedbackBtn')?.addEventListener('click', ()=>{
	const feedback = document.createElement('div');
	feedback.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;z-index:10001;min-width:400px;max-width:90vw;';
	feedback.innerHTML = `
		<h3 style="margin:0 0 12px;">Portal verbessern</h3>
		<p style="color:var(--muted);font-size:13px;margin:0 0 12px;">Was hat dich gestört? Wie würdest du es einfacher machen?</p>
		<textarea id="feedbackText" placeholder="Dein Feedback..." style="width:100%;min-height:120px;padding:8px;margin-bottom:8px;background:#0b0f14;border:1px solid var(--border);border-radius:8px;color:var(--ink);resize:vertical;"></textarea>
		<label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;">
			<input type="checkbox" id="feedbackPublic">
			<span>Darf dein Vorschlag öffentlich sichtbar sein?</span>
		</label>
		<div style="display:flex;gap:8px;justify-content:flex-end;">
			<button class="btn alt" onclick="this.closest('div').remove()">Abbrechen</button>
			<button class="btn" onclick="submitFeedback()">Absenden</button>
		</div>
	`;
	document.body.appendChild(feedback);
	setTimeout(()=> document.getElementById('feedbackText')?.focus(), 100);
});

window.submitFeedback = function(){
	const text = document.getElementById('feedbackText')?.value;
	const isPublic = document.getElementById('feedbackPublic')?.checked;
	if(!text) return alert('Bitte Feedback eingeben.');
	// Hier würde das Feedback gesendet werden
	alert(`✓ Feedback wurde ${isPublic ? 'öffentlich' : 'privat'} gesendet. Vielen Dank!`);
	document.querySelector('[style*="position:fixed"]')?.remove();
};

/* Entry point */
(async function init(){
	// Public mode by default
	renderFeed({posts:[]});
	// Try auto verify via hash params
	await tryAutoVerify();
	// Auto-Connect: Token lesen, mit Backend verifizieren und Präsenz/Matching starten
	await autoConnectFromToken();
	// Phase 3: Konversations-Start-Templates - One-Click-Buttons einrichten
	if(typeof setupQuickActionButtons === 'function'){
		setupQuickActionButtons();
	}
	// Hypotheken-Demo-Buttons verdrahten
	if(btnLoadApplications) btnLoadApplications.addEventListener('click', loadMortgageApplications);
	if(btnLoadOffers) btnLoadOffers.addEventListener('click', loadMortgageOffers);
	if(btnNewApplication) btnNewApplication.addEventListener('click', createExampleMortgageApplication);
	// Voucher & Termine UI initialisieren
	if(voucherModeCustomerBtn) voucherModeCustomerBtn.addEventListener('click', ()=> setVoucherMode('customer'));
	if(voucherModeIssuerBtn) voucherModeIssuerBtn.addEventListener('click', ()=> setVoucherMode('issuer'));
	if(voucherRefreshBtn) voucherRefreshBtn.addEventListener('click', loadVouchers);
	// Standard: Kunde-Ansicht
	if(voucherListEl && slotListEl){
		setVoucherMode('customer');
	}
	if(voucherTemplateButtons && voucherTemplateButtons.length){
		voucherTemplateButtons.forEach(btn=>{
			btn.addEventListener('click', ()=>{
				const key = btn.getAttribute('data-voucher-template');
				issueVoucherTemplate(key);
			});
		});
	}
	await loadEventsMembershipsOverview();
	await loadVerticalConsoles();
	await loadMyBookings();
	// Autopilot: Standard-Voucher einmalig erzeugen, falls noch nichts existiert
	await ensureDefaultVouchersForIssuer();
	installBasicTelemetry();
})();
</script>
<script type="module">
import { loadProviders } from './router.js';

async function renderSuppliers() {
	const container = document.getElementById('suppliersList');
	if (!container) return;
	container.textContent = 'Lade Provider-Profile …';
	try {
		const providers = await loadProviders();
		if (!providers.length) {
			container.textContent = 'Keine Provider-Profile konfiguriert.';
			return;
		}
		container.innerHTML = providers.map(p => {
			const tags = Array.isArray(p.tags) && p.tags.length ? ` · Tags: ${p.tags.join(', ')}` : '';
			const status = p.enabled === false ? 'deaktiviert' : 'aktiv';
			return `
				<div class="slot-item">
					<div>
						<div><strong>${p.label || p.id}</strong> <span class="voucher-meta">(${p.category || 'other'} · ${p.connector || 'n/a'})</span></div>
						<div class="voucher-meta">${p.description || ''}${tags}</div>
					</div>
					<span class="voucher-badge status-${status}">${status}</span>
				</div>
			`;
		}).join('');
	} catch (err) {
		container.textContent = 'Fehler beim Laden der Provider-Profile: ' + (err?.message || String(err));
	}
}

renderSuppliers().catch(() => {});
</script>
<script src="./ambient-media.js"></script>
<script type="module" src="./autofix-client.js"></script>
  <script src="./css/da-vinci-enterprise-standard-init.js"></script>
</body>
</html>

