<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DEVELOPER-NOTIZ-FIX</title>
<style>
body { font-family: system-ui; max-width: 800px; margin: 0 auto; padding: 20px; }
pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; }
</style>
</head>
<body>
<h1>TogetherSystems – Fix & Playwright-Setup</h1>

<h2>Was wurde gefixt?</h2>

<strong>Datei:</strong> `TELBANK/telbank-app.js`  
<strong>Funktion:</strong> `renderFlows()` (am Ende der Klasse `TpgaTelbankApp`)

<strong>Fehler:</strong> Kaputte String-Konkatenation mit falscher Klammerung beim Setzen von `this.$flowCount.textContent`.

<strong>Fix:</strong> `"(N flows)"` wird jetzt sauber gebaut:
```javascript
this.$flowCount.textContent =
  "(" +
  this.flows.length.toString() +
  (this.flows.length === 1 ? " flow" : " flows") +
  ")";
```

<h2>Warum war das ein Problem?</h2>

Das File hatte unbalancierte Klammern → <strong>JavaScript-Parserfehler</strong>.

Im schlimmsten Fall lädt das ganze Script nicht:
- ❌ Telbank-UI funktioniert nicht
- ❌ Playwright-Tests gegen Telbank brechen ggf. mit seltsamen Fehlermeldungen ab

<h2>Stand der restlichen Codebasis (ohne node_modules)</h2>

Alle eigenen `.js`-Files (ohne `node_modules`) wurden maschinell geprüft auf:
- ✅ <strong>Klammer-Balance</strong> `()`, `{}`, `[]` → alles OK nach dem Fix
- ✅ <strong>"NOT IMPLEMENTED"</strong>, <strong>"DUMMY"</strong>, <strong>"TODO"</strong>, <strong>"FIXME"</strong> → keine relevanten Treffer in deinem eigenen Code (nur im Playwright-Report-HTML)

---

<h2>Wie bringt man Playwright lokal zum Laufen?</h2>

Im Projekt gibt es:
- `businessconnecthub-playwright-tests-full/` mit `playwright.config.ts`

<h3>Schritte:</h3>

```bash
<h1>(1) ins Test-Projekt wechseln</h1>
cd businessconnecthub-playwright-tests-full

<h1>(2) Dependencies installieren</h1>
npm install

<h1>(3) Browser-Binaries installieren</h1>
npx playwright install
```

<strong>Server starten (Root vom Projekt):</strong>
```bash
<h1>im Projekt-Root</h1>
wrangler pages dev .

<h1>oder dein lokales Setup, das auf http://localhost:9323/ läuft</h1>
```

<strong>Dann in einem zweiten Terminal:</strong>
```bash
<h1>(4) Playwright-Tests ausführen</h1>
cd businessconnecthub-playwright-tests-full

npx playwright test --project=Chromium

<h1>oder alle Browser:</h1>
npx playwright test
```

<h3>Wichtig:</h3>

In `playwright.config.ts` steht:
```typescript
baseURL: process.env.PLAYWRIGHT_BASE_URL || 'http://localhost:9323/',
```

Wenn dein lokaler Server anders läuft (z. B. `http://127.0.0.1:8788/`), dann:
```bash
export PLAYWRIGHT_BASE_URL="http://127.0.0.1:8788/"
npx playwright test
```

---

<h2>Checkliste für "CI grün" (GitHub Actions + Playwright + env vars)</h2>

<h3>3.1 GitHub-Repo sauber halten</h3>

- ✅ `node_modules` nicht commiten (ist in `.gitignore` eh vorgesehen)
- ✅ Sicherstellen, dass folgende Dinge im Repo sind:
  - `package.json` (Root)
  - `businessconnecthub-playwright-tests-full/package.json`
  - `businessconnecthub-playwright-tests-full/playwright.config.ts`
  - `functions/` (Workers/Pages Functions)
  - `d1-schema.sql`

<h3>3.2 GitHub Action für Tests (Playwright)</h3>

Siehe `.github/workflows/playwright.yml` (bereits erstellt)

<strong>Wichtig:</strong>
- Node-Version passt (20)
- Dev-Server läuft (`npx http-server . -p 9323`)
- `PLAYWRIGHT_BASE_URL` zeigt auf den lokalen Port

<h3>3.3 GitHub Action für Deploy (Cloudflare)</h3>

Siehe `.github/workflows/deploy.yml` (bereits vorhanden)

<strong>GitHub Secrets müssen gesetzt sein:</strong>
- `CLOUDFLARE_ACCOUNT_ID`
- `CLOUDFLARE_API_TOKEN`
- ggf. `CLOUDFLARE_PROJECT_NAME` / `CLOUDFLARE_PAGES_PROJECT`

<h3>3.4 Runtime-Umgebung (Cloudflare / env vars)</h3>

<strong>In Cloudflare Pages/Workers müssen gesetzt sein:</strong>
- ✅ D1 Binding existiert als `DB`
- ✅ `TS_API_KEY` als Environment Variable gesetzt

<strong>Dann laufen:</strong>
- `/api/telbank/transfers`
- `/api/voucher/*`
- `/api/mortgage/*`
- `/api/telemetry`
- `/api/autofix/*`
- `/api/contracts/*` (so weit ohne R2 genutzt)
- `/api/presence/*`
- `/ws` (WebSocket) – unabhängig von D1

---

<h2>Zu deiner grundsätzlichen Frage: "Kann ich ZIP in neuen Ordner auf Localhost legen und von da aus pushen?"</h2>

<strong>Ja.</strong> Und zwar so:

Der Upload, den du mir gegeben hast, ist bereits ein vollständiges Projekt mit `.git`-Ordner.

Du kannst:
1. Das ZIP `togethersystems-fixed.zip` lokal entpacken
2. In dem Ordner ein neues Git-Repo anlegen (oder den vorhandenen `.git` verwenden, wenn du den mitkopierst)
3. Das Ganze in ein neues oder bestehendes GitHub-Repo pushen

<strong>Wichtig ist nur:</strong>
- Das GitHub-Repo, das du für Deploy benutzt, muss den Code-Stand enthalten, den du wirklich live haben willst
- Cloudflare Pages ist immer nur an ein konkretes Repo/Projekt gebunden – wohin du pushst, ist egal, solange Cloudflare das richtige Repo zieht
- Du musst keine Worker-Dateien umbauen. Das Routing `/api/...` und `/ws` ist sauber
</body>
</html>